<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ Pro+</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    *{-webkit-tap-highlight-color:transparent}body{margin:0;padding:0;overscroll-behavior:none}
    body.light{background:#f3f4f6;color:#1f2937}
    body.light .dark-bg{background:#fff!important}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .animate-pulse-slow{animation:pulse 2s infinite}
  </style>
</head>
<body class="bg-gray-900 text-white">
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef}=React;
const API=window.location.origin+'/api';

// ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
const calcRSI=(p,n=14)=>{if(p.length<n+1)return 50;let g=0,l=0;for(let i=1;i<=n;i++){const c=p[i-1]-p[i];c>0?g+=c:l-=c}return l===0?100:Math.round(100-(100/(1+(g/n)/(l/n))))};
const calcMACD=(p)=>{if(p.length<26)return{cross:'none'};const ema=(d,n)=>{let e=d.slice(0,n).reduce((a,b)=>a+b)/n;for(let i=n;i<d.length;i++)e=d[i]*(2/(n+1))+e*(1-2/(n+1));return e};const m=ema(p,12)-ema(p,26);return{cross:m>0?'golden':'dead',val:m.toFixed(0)}};
const calcBB=(p,n=20)=>{if(p.length<n)return{pos:'mid'};const s=p.slice(0,n),avg=s.reduce((a,b)=>a+b)/n,std=Math.sqrt(s.reduce((x,v)=>x+Math.pow(v-avg,2),0)/n);return{pos:p[0]>=avg+std*2?'high':p[0]<=avg-std*2?'low':'mid',u:avg+std*2,l:avg-std*2}};
const calcStoch=(data,k=14)=>{if(data.length<k)return{k:50,sig:'ì¤‘ë¦½'};const highs=data.slice(0,k).map(x=>x.h),lows=data.slice(0,k).map(x=>x.l);const hh=Math.max(...highs),ll=Math.min(...lows);const kVal=hh===ll?50:((data[0].c-ll)/(hh-ll))*100;let sig='ì¤‘ë¦½';if(kVal>80)sig='ê³¼ë§¤ìˆ˜';else if(kVal<20)sig='ê³¼ë§¤ë„';else if(kVal>50)sig='ìƒìŠ¹ì¤‘';else sig='í•˜ë½ì¤‘';return{k:Math.round(kVal),sig}};
const calcOBV=(data)=>{if(data.length<10)return{trend:'ë¶€ì¡±',val:0};let obv=0;for(let i=data.length-1;i>0;i--){if(data[i-1].c>data[i].c)obv+=data[i-1].v;else if(data[i-1].c<data[i].c)obv-=data[i-1].v}const obv5=data.slice(0,5).reduce((s,x,i)=>{if(i===0)return 0;if(data[i-1].c>data[i].c)return s+data[i-1].v;if(data[i-1].c<data[i].c)return s-data[i-1].v;return s},0);let trend='íš¡ë³´';if(obv5>0&&data[0].c>data[4].c)trend='ìƒìŠ¹í™•ì¸';else if(obv5<0&&data[0].c<data[4].c)trend='í•˜ë½í™•ì¸';else if(obv5>0&&data[0].c<data[4].c)trend='ìƒìŠ¹ë‹¤ì´ë²„';else if(obv5<0&&data[0].c>data[4].c)trend='í•˜ë½ë‹¤ì´ë²„';return{trend,val:(obv/1e6).toFixed(0)}};
const calcWilliams=(data,n=14)=>{if(data.length<n)return{val:-50,sig:'ì¤‘ë¦½'};const highs=data.slice(0,n).map(x=>x.h),lows=data.slice(0,n).map(x=>x.l);const hh=Math.max(...highs),ll=Math.min(...lows);const wr=hh===ll?-50:((hh-data[0].c)/(hh-ll))*-100;let sig='ì¤‘ë¦½';if(wr>-20)sig='ê³¼ë§¤ìˆ˜';else if(wr<-80)sig='ê³¼ë§¤ë„';return{val:Math.round(wr),sig}};
const calcCCI=(data,n=20)=>{if(data.length<n)return{val:0,sig:'ì¤‘ë¦½'};const tp=data.slice(0,n).map(x=>(x.h+x.l+x.c)/3);const sma=tp.reduce((a,b)=>a+b)/n;const md=tp.reduce((s,v)=>s+Math.abs(v-sma),0)/n;const cci=md===0?0:(tp[0]-sma)/(0.015*md);let sig='ì¤‘ë¦½';if(cci>100)sig='ê³¼ë§¤ìˆ˜';else if(cci<-100)sig='ê³¼ë§¤ë„';else if(cci>0)sig='ê°•ì„¸';else sig='ì•½ì„¸';return{val:Math.round(cci),sig}};
const calcVol=(v)=>{if(v.length<20)return{r:1,s:'ë³´í†µ'};const avg=v.slice(0,20).reduce((a,b)=>a+b)/20,r=v[0]/avg;return{r:r.toFixed(1),s:r>=3?'í­ì¦':r>=2?'ê¸‰ì¦':r>=1.5?'ì¦ê°€':'ë³´í†µ'}};
const detectCandle=(c)=>{if(c.length<2)return{p:'ì—†ìŒ',sig:'n'};const[t,y]=c,b=t.c-t.o,rng=t.h-t.l,ls=Math.min(t.o,t.c)-t.l;if(ls>Math.abs(b)*2)return{p:'ë§ì¹˜í˜•',sig:'b'};if(Math.abs(b)<rng*0.1)return{p:'ë„ì§€',sig:'n'};const yb=y.c-y.o;if(b>0&&yb<0&&Math.abs(b)>Math.abs(yb))return{p:'ìƒìŠ¹ì¥ì•…',sig:'b'};if(b<0&&yb>0&&Math.abs(b)>Math.abs(yb))return{p:'í•˜ë½ì¥ì•…',sig:'s'};return{p:'ì—†ìŒ',sig:'n'}};
const getMA=(p)=>{if(p.length<60)return'ë¶€ì¡±';const m5=p.slice(0,5).reduce((a,b)=>a+b)/5,m20=p.slice(0,20).reduce((a,b)=>a+b)/20,m60=p.slice(0,60).reduce((a,b)=>a+b)/60;if(m5>m20&&m20>m60)return'ì •ë°°ì—´';if(m5<m20&&m20<m60)return'ì—­ë°°ì—´';return p[0]>m60?'60ì¼â†‘':p[0]>m20?'20ì¼â†‘':'í˜¼ì¡°'};

// ê¸‰ë“± í›„ ëˆŒë¦¼ëª© ë¶„ì„ (3~6ê°œì›” ë°ì´í„° í•„ìš”)
const analyzePostSurge=(data)=>{
  if(data.length<60)return{isPostSurge:false,status:'ë°ì´í„°ë¶€ì¡±'};
  
  const prices=data.map(x=>x.c);
  const cur=prices[0];
  
  // 3ê°œì›”(60ì¼) ~ 6ê°œì›”(120ì¼) ë²”ìœ„ì—ì„œ ê³ ì  ì°¾ê¸°
  const range3m=prices.slice(0,Math.min(60,prices.length));
  const range6m=prices.slice(0,Math.min(120,prices.length));
  
  const high3m=Math.max(...range3m);
  const high6m=Math.max(...range6m);
  const low3m=Math.min(...range3m);
  
  // ìµœê·¼ 20ì¼ ì €ì 
  const recent20=prices.slice(0,20);
  const recentLow=Math.min(...recent20);
  const recentHigh=Math.max(...recent20);
  
  // ê³ ì  ëŒ€ë¹„ í•˜ë½ë¥ 
  const dropFrom3mHigh=((high3m-cur)/high3m*100).toFixed(1);
  const dropFrom6mHigh=((high6m-cur)/high6m*100).toFixed(1);
  
  // ì €ì  ëŒ€ë¹„ í˜„ì¬ ìœ„ì¹˜
  const fromLow=((cur-low3m)/low3m*100).toFixed(1);
  
  // ê¸‰ë“± í›„ ëˆŒë¦¼ëª© ì¡°ê±´ ì²´í¬
  // 1. 3~6ê°œì›” ë‚´ ê³ ì  ëŒ€ë¹„ 30% ì´ìƒ í•˜ë½
  // 2. í˜„ì¬ê°€ê°€ ìµœê·¼ 20ì¼ ì €ì  ê·¼ì²˜ (5% ì´ë‚´)
  // 3. 3ê°œì›” ë‚´ ìµœì €ì  ëŒ€ë¹„ 10% ì´ë‚´
  
  const isNearRecentLow=((cur-recentLow)/recentLow*100)<5;
  const isNear3mLow=((cur-low3m)/low3m*100)<10;
  const hadBigDrop=dropFrom6mHigh>30;
  
  let status='ì¼ë°˜';
  let score=0;
  let details=[];
  
  if(hadBigDrop&&dropFrom6mHigh>30){
    score+=30;
    details.push(`6ê°œì›”ê³ ì ëŒ€ë¹„ -${dropFrom6mHigh}%`);
  }
  if(dropFrom3mHigh>20){
    score+=20;
    details.push(`3ê°œì›”ê³ ì ëŒ€ë¹„ -${dropFrom3mHigh}%`);
  }
  if(isNear3mLow){
    score+=25;
    details.push(`3ê°œì›”ì €ì  ê·¼ì²˜`);
  }
  if(isNearRecentLow){
    score+=15;
    details.push(`ìµœê·¼ì €ì  ê·¼ì²˜`);
  }
  
  // ê±°ë˜ëŸ‰ ë°”ë‹¥ í™•ì¸ (ìµœê·¼ ê±°ë˜ëŸ‰ì´ í‰ê· ë³´ë‹¤ ë‚®ìœ¼ë©´ ë°”ë‹¥ ê°€ëŠ¥ì„±)
  const vols=data.map(x=>x.v);
  const avgVol=vols.slice(0,60).reduce((a,b)=>a+b)/60;
  const recentVol=vols.slice(0,5).reduce((a,b)=>a+b)/5;
  if(recentVol<avgVol*0.7){
    score+=10;
    details.push('ê±°ë˜ëŸ‰ ë°”ë‹¥');
  }
  
  const isPostSurge=score>=50;
  
  if(score>=70)status='ğŸ”¥ê¸‰ë“±í›„ì €ì (ê°•ë ¥)';
  else if(score>=50)status='ğŸ“‰ê¸‰ë“±í›„ì €ì ';
  else if(score>=30)status='ëˆŒë¦¼ëª©';
  else status='ì¼ë°˜';
  
  // ë°˜ë“± ì‹œ ëª©í‘œê°€ ê³„ì‚°
  const targetPrice=Math.round(cur*1.3); // 30% ë°˜ë“± ëª©í‘œ
  const recoveryTarget=Math.round(high3m*0.7); // ê³ ì ì˜ 70%ê¹Œì§€ íšŒë³µ
  
  return{
    isPostSurge,
    status,
    score,
    details,
    high3m,
    high6m,
    low3m,
    dropFrom3mHigh:+dropFrom3mHigh,
    dropFrom6mHigh:+dropFrom6mHigh,
    fromLow:+fromLow,
    targetPrice,
    recoveryTarget:Math.max(targetPrice,recoveryTarget)
  };
};

const getSig=(rsi,ma,macd,bb,stoch,cci,postSurge)=>{
  let s=0;
  if(rsi<30)s+=2;else if(rsi>70)s-=2;
  if(ma==='ì •ë°°ì—´')s+=2;else if(ma==='ì—­ë°°ì—´')s-=2;
  if(macd?.cross==='golden')s+=1;else if(macd?.cross==='dead')s-=1;
  if(bb?.pos==='low')s+=1;else if(bb?.pos==='high')s-=1;
  if(stoch?.sig==='ê³¼ë§¤ë„')s+=1;else if(stoch?.sig==='ê³¼ë§¤ìˆ˜')s-=1;
  if(cci?.sig==='ê³¼ë§¤ë„')s+=1;else if(cci?.sig==='ê³¼ë§¤ìˆ˜')s-=1;
  if(postSurge?.isPostSurge)s+=2; // ê¸‰ë“±í›„ì €ì  ë³´ë„ˆìŠ¤
  return s>=4?'ê°•ë ¥ë§¤ìˆ˜':s>=2?'ë§¤ìˆ˜':s<=-4?'ê°•ë ¥ë§¤ë„':s<=-2?'ë§¤ë„':'ê´€ë§';
};

const getStrat=(rsi,ma,chg,vol,macd,cnd,stoch,obv,postSurge)=>{
  if(postSurge?.isPostSurge&&postSurge?.score>=70)return'ğŸ”¥ê¸‰ë“±í›„ì €ì ë§¤ìˆ˜';
  if(postSurge?.isPostSurge)return'ğŸ“‰ëˆŒë¦¼ëª©ë°˜ë“±';
  if(chg>10&&vol.s==='í­ì¦')return'ğŸ”¥ë‰´ìŠ¤ë§¤ë§¤';
  if(macd?.cross==='golden'&&stoch?.sig==='ìƒìŠ¹ì¤‘')return'ğŸš€MACD+ìŠ¤í† ìºê³¨ë“ ';
  if(macd?.cross==='golden')return'ğŸ“ˆMACDê³¨ë“ ';
  if(obv?.trend==='ìƒìŠ¹ë‹¤ì´ë²„')return'ğŸ’OBVë‹¤ì´ë²„ì „ìŠ¤';
  if(cnd?.sig==='b')return'ğŸ•¯ï¸ìº”ë“¤('+cnd.p+')';
  if(ma==='ì •ë°°ì—´'&&rsi>50&&rsi<70)return'ğŸ“Šì¶”ì„¸ë§¤ë§¤';
  if(stoch?.sig==='ê³¼ë§¤ë„'&&rsi<35)return'ğŸ”„ê³¼ë§¤ë„ë°˜ë“±';
  if(ma.includes('â†‘'))return'ğŸ“‰ëˆŒë¦¼ëª©';
  if(rsi<30)return'ğŸ’¡ì—­ë°œìƒ';
  return'ğŸ‘€ê´€ë§';
};

// AI ë§¤ë§¤ ì¶”ì²œ
const generateAIAdvice=(stock)=>{
  const{rsi,ma,macd,bb,stoch,cci,obv,vol,cnd,chg,postSurge}=stock;
  let score=0,reasons=[],action='',confidence=0;
  
  if(rsi<30){score+=15;reasons.push('RSI ê³¼ë§¤ë„')}
  else if(rsi<40){score+=8;reasons.push('RSI ë§¤ìˆ˜ì ì •')}
  else if(rsi>70){score-=15;reasons.push('RSI ê³¼ë§¤ìˆ˜')}
  
  if(ma==='ì •ë°°ì—´'){score+=20;reasons.push('ì´í‰ì„  ì •ë°°ì—´')}
  else if(ma==='ì—­ë°°ì—´'){score-=20;reasons.push('ì´í‰ì„  ì—­ë°°ì—´')}
  else if(ma==='60ì¼â†‘'){score+=10;reasons.push('60ì¼ì„  ì§€ì§€')}
  
  if(macd?.cross==='golden'){score+=15;reasons.push('MACD ê³¨ë“ í¬ë¡œìŠ¤')}
  else if(macd?.cross==='dead'){score-=15;reasons.push('MACD ë°ë“œí¬ë¡œìŠ¤')}
  
  if(bb?.pos==='low'){score+=10;reasons.push('ë³¼ë¦°ì € í•˜ë‹¨')}
  else if(bb?.pos==='high'){score-=10;reasons.push('ë³¼ë¦°ì € ìƒë‹¨')}
  
  if(stoch?.sig==='ê³¼ë§¤ë„'){score+=10;reasons.push('ìŠ¤í† ìºìŠ¤í‹± ê³¼ë§¤ë„')}
  else if(stoch?.sig==='ê³¼ë§¤ìˆ˜'){score-=10;reasons.push('ìŠ¤í† ìºìŠ¤í‹± ê³¼ë§¤ìˆ˜')}
  
  if(obv?.trend==='ìƒìŠ¹í™•ì¸'){score+=12;reasons.push('OBV ìƒìŠ¹')}
  else if(obv?.trend==='ìƒìŠ¹ë‹¤ì´ë²„'){score+=15;reasons.push('OBV ìƒìŠ¹ë‹¤ì´ë²„ì „ìŠ¤!')}
  else if(obv?.trend==='í•˜ë½ë‹¤ì´ë²„'){score-=15;reasons.push('OBV í•˜ë½ë‹¤ì´ë²„ì „ìŠ¤')}
  
  if(vol?.s==='í­ì¦'){score+=5;reasons.push('ê±°ë˜ëŸ‰ í­ì¦')}
  if(cnd?.sig==='b'){score+=8;reasons.push('ìƒìŠ¹ìº”ë“¤: '+cnd.p)}
  else if(cnd?.sig==='s'){score-=8;reasons.push('í•˜ë½ìº”ë“¤: '+cnd.p)}
  
  // ê¸‰ë“±í›„ì €ì  ë³´ë„ˆìŠ¤
  if(postSurge?.isPostSurge){
    score+=25;
    reasons.unshift('ğŸ”¥ê¸‰ë“±í›„ì €ì ('+postSurge.score+'ì )');
    if(postSurge.details?.length>0)reasons.push(...postSurge.details.slice(0,2));
  }
  
  if(score>=40){action='ğŸŸ¢ ì ê·¹ë§¤ìˆ˜';confidence=Math.min(95,60+score)}
  else if(score>=20){action='ğŸ”µ ë§¤ìˆ˜ê³ ë ¤';confidence=Math.min(80,50+score)}
  else if(score>=-10){action='âšª ê´€ë§';confidence=50}
  else if(score>=-30){action='ğŸŸ  ë§¤ë„ê³ ë ¤';confidence=Math.min(80,50-score)}
  else{action='ğŸ”´ ì ê·¹ë§¤ë„';confidence=Math.min(95,60-score)}
  
  let risk='ì¤‘ê°„';
  if(vol?.s==='í­ì¦'||Math.abs(chg)>10)risk='ë†’ìŒ';
  else if(ma==='ì •ë°°ì—´'&&rsi>40&&rsi<60)risk='ë‚®ìŒ';
  else if(postSurge?.isPostSurge)risk='ì¤‘ê°„(ë°˜ë“±ê¸°ëŒ€)';
  
  const price=stock.price;
  let target=0,stopLoss=0;
  if(postSurge?.isPostSurge){
    target=postSurge.recoveryTarget;
    stopLoss=Math.round(price*0.93);
  }else if(score>0){
    target=Math.round(price*1.1);
    stopLoss=Math.round(price*0.95);
  }else{
    target=Math.round(price*0.95);
    stopLoss=Math.round(price*1.05);
  }
  
  return{score,action,confidence,reasons:reasons.slice(0,6),risk,target,stopLoss};
};

const fmtVol=(v)=>v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v;

// ì°¨íŠ¸
const Chart_=({data,name,period})=>{
  const ref=useRef(),chart=useRef();
  useEffect(()=>{
    if(!ref.current||!data?.length)return;
    chart.current?.destroy();
    let days={w:7,m:30,q:60,h:120,y:250}[period]||60;
    const d=data.slice(0,days),labels=d.map(x=>x.dt).reverse(),prices=d.map(x=>x.c).reverse();
    const ma5=[],ma20=[],ma60=[];
    for(let i=0;i<prices.length;i++){
      ma5.push(i>=4?prices.slice(i-4,i+1).reduce((a,b)=>a+b)/5:null);
      ma20.push(i>=19?prices.slice(i-19,i+1).reduce((a,b)=>a+b)/20:null);
      ma60.push(i>=59?prices.slice(i-59,i+1).reduce((a,b)=>a+b)/60:null);
    }
    chart.current=new window.Chart(ref.current,{type:'line',data:{labels,datasets:[
      {label:'ì¢…ê°€',data:prices,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.1,pointRadius:0,borderWidth:2},
      {label:'MA5',data:ma5,borderColor:'#f59e0b',borderWidth:1,pointRadius:0,borderDash:[3,3]},
      {label:'MA20',data:ma20,borderColor:'#ef4444',borderWidth:1,pointRadius:0,borderDash:[3,3]},
      {label:'MA60',data:ma60,borderColor:'#8b5cf6',borderWidth:1,pointRadius:0,borderDash:[3,3]}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{color:'#9ca3af',font:{size:8},boxWidth:8}}},scales:{x:{ticks:{color:'#6b7280',maxTicksLimit:5,font:{size:7}},grid:{color:'#374151'}},y:{ticks:{color:'#6b7280',font:{size:7}},grid:{color:'#374151'}}}}});
    return()=>chart.current?.destroy();
  },[data,period]);
  return <div className="h-40"><canvas ref={ref}/></div>;
};

const VolChart=({data,period})=>{
  const ref=useRef(),chart=useRef();
  useEffect(()=>{
    if(!ref.current||!data?.length)return;
    chart.current?.destroy();
    let days={w:7,m:30,q:60,h:120,y:250}[period]||60;
    const d=data.slice(0,days),labels=d.map(x=>x.dt).reverse(),vols=d.map(x=>x.v/1e6).reverse(),colors=d.map(x=>x.c>=x.o?'rgba(239,68,68,0.7)':'rgba(59,130,246,0.7)').reverse();
    chart.current=new window.Chart(ref.current,{type:'bar',data:{labels,datasets:[{data:vols,backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{ticks:{color:'#6b7280',font:{size:6}},grid:{color:'#374151'}}}}});
    return()=>chart.current?.destroy();
  },[data,period]);
  return <div className="h-14"><canvas ref={ref}/></div>;
};

const App=()=>{
  const[key,setKey]=useState(localStorage.getItem('k')||'');
  const[sec,setSec]=useState(localStorage.getItem('s')||'');
  const[save,setSave]=useState(localStorage.getItem('sv')==='1');
  const[logged,setLogged]=useState(false);
  const[tab,setTab]=useState('scan');
  const[mode,setMode]=useState('day');
  const[price,setPrice]=useState('low');
  const[load,setLoad]=useState(false);
  const[err,setErr]=useState('');
  const[list,setList]=useState([]);
  const[sel,setSel]=useState(null);
  const[upd,setUpd]=useState('');
  const[prog,setProg]=useState('');
  const[period,setPeriod]=useState('q');
  const[favs,setFavs]=useState(()=>JSON.parse(localStorage.getItem('fav')||'[]'));
  const[port,setPort]=useState(()=>JSON.parse(localStorage.getItem('port')||'[]'));
  const[alerts,setAlerts]=useState(()=>JSON.parse(localStorage.getItem('alrt')||'[]'));
  const[alertOn,setAlertOn]=useState(localStorage.getItem('alrtOn')!=='0');
  const[dark,setDark]=useState(localStorage.getItem('dk')!=='0');
  const[charts,setCharts]=useState({});
  const[modal,setModal]=useState(null);
  const[form,setForm]=useState({});
  const[search,setSearch]=useState('');
  const[memos,setMemos]=useState(()=>JSON.parse(localStorage.getItem('memos')||'{}'));
  const[news,setNews]=useState({});
  const[autoRefresh,setAutoRefresh]=useState(localStorage.getItem('autoRef')==='1');
  const[refreshInterval,setRefreshInterval]=useState(+(localStorage.getItem('refInt')||'60'));
  const[showAI,setShowAI]=useState(null);

  useEffect(()=>{localStorage.setItem('fav',JSON.stringify(favs))},[favs]);
  useEffect(()=>{localStorage.setItem('port',JSON.stringify(port))},[port]);
  useEffect(()=>{localStorage.setItem('alrt',JSON.stringify(alerts))},[alerts]);
  useEffect(()=>{localStorage.setItem('alrtOn',alertOn?'1':'0')},[alertOn]);
  useEffect(()=>{localStorage.setItem('dk',dark?'1':'0');document.body.className=dark?'bg-gray-900 text-white':'light bg-gray-100 text-gray-900'},[dark]);
  useEffect(()=>{localStorage.setItem('memos',JSON.stringify(memos))},[memos]);
  useEffect(()=>{localStorage.setItem('autoRef',autoRefresh?'1':'0')},[autoRefresh]);
  useEffect(()=>{localStorage.setItem('refInt',refreshInterval)},[refreshInterval]);
  useEffect(()=>{if(save&&key&&sec)login()},[]);

  useEffect(()=>{
    if(!autoRefresh||!logged)return;
    const iv=setInterval(()=>{
      if(tab==='scan')scan();
      else if(tab==='fav')refreshFav();
      else if(tab==='port')refreshPort();
    },refreshInterval*1000);
    return()=>clearInterval(iv);
  },[autoRefresh,refreshInterval,logged,tab]);

  const login=async()=>{
    if(!key||!sec){setErr('KEY/SECRET ì…ë ¥');return}
    setLoad(true);setErr('');
    try{
      const r=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec})});
      if(r.ok){if(save){localStorage.setItem('k',key);localStorage.setItem('s',sec);localStorage.setItem('sv','1')}setLogged(true);if(Notification.permission==='default')Notification.requestPermission()}
      else{const d=await r.json();setErr(d.error||'ì‹¤íŒ¨')}
    }catch(e){setErr(e.message)}
    setLoad(false);
  };

  const logout=()=>{setLogged(false);setList([]);localStorage.removeItem('k');localStorage.removeItem('s');localStorage.removeItem('sv');setKey('');setSec('')};

  const loadChart=async(code)=>{
    if(charts[code])return charts[code];
    try{
      const r=await fetch(API+'/daily-chart',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:code})});
      const d=await r.json();
      if(d.success&&d.data){
        const f=d.data.map(x=>({dt:x.stck_bsop_date.slice(4,6)+'/'+x.stck_bsop_date.slice(6,8),o:+x.stck_oprc,h:+x.stck_hgpr,l:+x.stck_lwpr,c:+x.stck_clpr,v:+x.acml_vol})).filter(x=>x.c>0);
        setCharts(p=>({...p,[code]:f}));return f;
      }
    }catch{}return[];
  };

  const loadNews=async(name)=>{
    const mockNews=[
      {title:`${name}, ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜ ì§€ì†`,time:'1ì‹œê°„ì „',sent:'p'},
      {title:`${name} ì‹¤ì  ì „ë§ ìƒí–¥`,time:'3ì‹œê°„ì „',sent:'p'},
      {title:`ì¦ê¶Œê°€ "${name}" ëª©í‘œê°€â†‘`,time:'5ì‹œê°„ì „',sent:'p'},
      {title:`${name}, ì‹ ì‚¬ì—… ì§„ì¶œ`,time:'ì˜¤ëŠ˜',sent:'n'},
      {title:`${name} í…Œë§ˆì£¼ ë™ë°˜ìƒìŠ¹`,time:'ì˜¤ëŠ˜',sent:'p'}
    ];
    setNews(p=>({...p,[name]:mockNews}));
  };

  const analyze=async(code,name,rawData)=>{
    const ch=rawData||await loadChart(code);
    const prices=ch.map(x=>x.c),vols=ch.map(x=>x.v);
    const rsi=calcRSI(prices),ma=getMA(prices),macd=calcMACD(prices),bb=calcBB(prices);
    const vol=calcVol(vols),cnd=detectCandle(ch.slice(0,3));
    const stoch=calcStoch(ch),obv=calcOBV(ch),williams=calcWilliams(ch),cci=calcCCI(ch);
    const postSurge=analyzePostSurge(ch);
    return{rsi,ma,macd,bb,vol,cnd,stoch,obv,williams,cci,postSurge,sig:getSig(rsi,ma,macd,bb,stoch,cci,postSurge),strat:getStrat(rsi,ma,0,vol,macd,cnd,stoch,obv,postSurge)};
  };

  const scan=async()=>{
    setLoad(true);setErr('');setProg('ì¡°íšŒì¤‘...');
    const pMin=price==='low'?'10':'1000',pMax=price==='low'?'999':'9999';
    try{
      const[vr,cr]=await Promise.all([
        fetch(API+'/volume-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:pMin,priceMax:pMax})}).then(r=>r.json()),
        fetch(API+'/change-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:pMin,priceMax:pMax,isUp:true})}).then(r=>r.json())
      ]);
      const map=new Map();
      [...(vr.data||[]),...(cr.data||[])].forEach(s=>{const c=s.mksc_shrn_iscd||s.stck_shrn_iscd;if(c&&!map.has(c))map.set(c,s)});
      const top=Array.from(map.values()).slice(0,15),result=[];
      for(let i=0;i<top.length;i++){
        const s=top[i],code=s.mksc_shrn_iscd||s.stck_shrn_iscd;
        setProg(`ë¶„ì„ì¤‘(${i+1}/${top.length}) ${s.hts_kor_isnm}`);
        await new Promise(r=>setTimeout(r,200));
        const ch=await loadChart(code),a=await analyze(code,s.hts_kor_isnm,ch);
        const stock={code,name:s.hts_kor_isnm,price:+s.stck_prpr||0,chg:+s.prdy_ctrt||0,vol:+s.acml_vol||0,h52:+s.w52_hgpr||0,l52:+s.w52_lwpr||0,...a};
        stock.ai=generateAIAdvice(stock);
        result.push(stock);
      }
      
      let sorted;
      if(mode==='day'){
        sorted=result.sort((a,b)=>(b.chg*2+b.vol/1e6)-(a.chg*2+a.vol/1e6));
      }else if(mode==='swing'){
        sorted=result.sort((a,b)=>{const sc={ì •ë°°ì—´:3,'60ì¼â†‘':2,'20ì¼â†‘':1};return((sc[b.ma]||0)*10+b.ai.score)-((sc[a.ma]||0)*10+a.ai.score)});
      }else if(mode==='bottom'){
        // ê¸‰ë“±í›„ì €ì  ëª¨ë“œ
        sorted=result.filter(s=>s.postSurge?.score>=30).sort((a,b)=>(b.postSurge?.score||0)-(a.postSurge?.score||0));
        if(sorted.length===0){
          sorted=result.sort((a,b)=>(b.postSurge?.score||0)-(a.postSurge?.score||0));
        }
      }
      
      setList(sorted.slice(0,5));setUpd(new Date().toLocaleString('ko-KR'));
    }catch(e){setErr(e.message)}
    setLoad(false);setProg('');
  };

  const refreshFav=async()=>{
    if(!favs.length)return;setLoad(true);setProg('ê´€ì‹¬ì¢…ëª© ì—…ë°ì´íŠ¸...');
    const result=[];
    for(let i=0;i<favs.length;i++){
      const f=favs[i];setProg(`ì¡°íšŒì¤‘(${i+1}/${favs.length}) ${f.name}`);
      await new Promise(r=>setTimeout(r,200));
      try{
        const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:f.code})}).then(r=>r.json());
        const ch=await loadChart(f.code),a=await analyze(f.code,f.name,ch);
        const stock={...f,price:+pr.data?.stck_prpr||0,chg:+pr.data?.prdy_ctrt||0,vol:+pr.data?.acml_vol||0,h52:+pr.data?.w52_hgpr||0,l52:+pr.data?.w52_lwpr||0,...a};
        stock.ai=generateAIAdvice(stock);
        result.push(stock);
      }catch{result.push({...f,err:true})}
    }
    setList(result);setUpd(new Date().toLocaleString('ko-KR'));setLoad(false);setProg('');
  };

  const refreshPort=async()=>{
    if(!port.length)return;setLoad(true);setProg('í¬íŠ¸í´ë¦¬ì˜¤ ì—…ë°ì´íŠ¸...');
    const result=[];
    for(let i=0;i<port.length;i++){
      const p=port[i];setProg(`ì¡°íšŒì¤‘(${i+1}/${port.length}) ${p.name}`);
      await new Promise(r=>setTimeout(r,200));
      try{
        const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:p.code})}).then(r=>r.json());
        const cur=+pr.data?.stck_prpr||0,pnl=((cur-p.buy)/p.buy*100).toFixed(2),amt=(cur-p.buy)*p.qty;
        result.push({...p,cur,chg:+pr.data?.prdy_ctrt||0,pnl:+pnl,amt,total:cur*p.qty});
      }catch{result.push({...p,err:true})}
    }
    setList(result);setUpd(new Date().toLocaleString('ko-KR'));setLoad(false);setProg('');
  };

  const searchStock=async()=>{
    if(!search.trim())return;setLoad(true);setErr('');
    try{
      const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:search})}).then(r=>r.json());
      if(pr.success&&pr.data){
        const ch=await loadChart(search),a=await analyze(search,pr.data.hts_kor_isnm||search,ch);
        const stock={code:search,name:pr.data.hts_kor_isnm||search,price:+pr.data.stck_prpr||0,chg:+pr.data.prdy_ctrt||0,vol:+pr.data.acml_vol||0,h52:+pr.data.w52_hgpr||0,l52:+pr.data.w52_lwpr||0,...a};
        stock.ai=generateAIAdvice(stock);
        setList([stock]);
        loadNews(stock.name);
      }else setErr('ì¢…ëª©ì—†ìŒ. 6ìë¦¬ ì½”ë“œ ì…ë ¥');
    }catch(e){setErr(e.message)}
    setLoad(false);
  };

  const isFav=(c)=>favs.some(f=>f.code===c);
  const togFav=(s,e)=>{e?.stopPropagation();setFavs(isFav(s.code)?favs.filter(f=>f.code!==s.code):[...favs,{code:s.code,name:s.name}])};
  const addPort=(s)=>{setForm({code:s.code,name:s.name,buy:s.price||s.cur,qty:''});setModal('port')};
  const savePort=()=>{if(!form.buy||!form.qty)return;const ex=port.findIndex(p=>p.code===form.code);if(ex>=0){const o=port[ex],tq=o.qty+ +form.qty,avg=Math.round((o.buy*o.qty+ +form.buy*+form.qty)/tq);setPort(port.map((p,i)=>i===ex?{...o,buy:avg,qty:tq}:p))}else setPort([...port,{code:form.code,name:form.name,buy:+form.buy,qty:+form.qty}]);setModal(null)};
  const delPort=(c)=>setPort(port.filter(p=>p.code!==c));
  const addAlert=(s)=>{setForm({code:s.code,name:s.name,type:'target',val:''});setModal('alert')};
  const saveAlert=()=>{if(!form.val)return;setAlerts([...alerts,{...form,val:+form.val,on:true}]);setModal(null)};
  const delAlert=(i)=>setAlerts(alerts.filter((_,j)=>j!==i));
  const togAlert=(i)=>{const a=[...alerts];a[i].on=!a[i].on;setAlerts(a)};
  const saveMemo=(code,text)=>setMemos({...memos,[code]:text});

  useEffect(()=>{
    if(!alertOn||!logged)return;
    const chk=async()=>{
      for(const a of alerts){
        if(!a.on)continue;
        try{
          const r=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:a.code})}).then(r=>r.json());
          const cur=+r.data?.stck_prpr||0,chg=+r.data?.prdy_ctrt||0;
          let fire=false,msg='';
          if(a.type==='target'&&cur>=a.val){fire=true;msg=`${a.name} ëª©í‘œê°€ ${a.val.toLocaleString()}ì› ë„ë‹¬!`}
          else if(a.type==='stop'&&cur<=a.val){fire=true;msg=`${a.name} ì†ì ˆê°€!`}
          else if(a.type==='surge'&&chg>=a.val){fire=true;msg=`${a.name} +${chg}% ê¸‰ë“±!`}
          else if(a.type==='plunge'&&chg<=-a.val){fire=true;msg=`${a.name} ${chg}% ê¸‰ë½!`}
          if(fire&&Notification.permission==='granted')new Notification('ğŸ“ˆì£¼ì‹ì•Œë¦¼',{body:msg});
        }catch{}
      }
    };
    const iv=setInterval(chk,60000);return()=>clearInterval(iv);
  },[alerts,alertOn,logged,key,sec]);

  const SigBadge=({s})=>{
    const colors={'ê°•ë ¥ë§¤ìˆ˜':'bg-green-600','ë§¤ìˆ˜':'bg-green-500','ê´€ë§':'bg-yellow-500 text-black','ë§¤ë„':'bg-red-500','ê°•ë ¥ë§¤ë„':'bg-red-600'};
    return<span className={`px-2 py-0.5 rounded-full text-xs font-bold ${colors[s]||'bg-gray-500'}`}>{s}</span>;
  };

  const AIPanel=({stock})=>{
    const ai=stock.ai;
    if(!ai)return null;
    return(
      <div className="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-lg p-3 mt-2 border border-purple-500/30">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-bold">ğŸ¤– AI ë¶„ì„</span>
          <span className={`text-lg font-bold ${ai.score>0?'text-green-400':'text-red-400'}`}>{ai.score>0?'+':''}{ai.score}ì </span>
        </div>
        <div className="text-center mb-2">
          <div className="text-xl font-bold">{ai.action}</div>
          <div className="text-xs text-gray-400">ì‹ ë¢°ë„ {ai.confidence}%</div>
          <div className="w-full bg-gray-700 rounded-full h-1.5 mt-1"><div className={`h-1.5 rounded-full ${ai.score>0?'bg-green-500':'bg-red-500'}`} style={{width:`${ai.confidence}%`}}/></div>
        </div>
        <div className="grid grid-cols-3 gap-1 text-xs mb-2">
          <div className="bg-gray-800/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">ë¦¬ìŠ¤í¬</div><div className={`font-bold ${ai.risk==='ë†’ìŒ'?'text-red-400':ai.risk==='ë‚®ìŒ'?'text-green-400':'text-yellow-400'}`}>{ai.risk}</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">ëª©í‘œê°€</div><div className="font-bold text-green-400">{ai.target?.toLocaleString()}</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">ì†ì ˆê°€</div><div className="font-bold text-red-400">{ai.stopLoss?.toLocaleString()}</div></div>
        </div>
        <div className="text-xs"><div className="text-gray-400 mb-1">ğŸ“Š ë¶„ì„ê·¼ê±°:</div>{ai.reasons?.map((r,i)=><div key={i} className="text-gray-300 ml-1 text-[10px]">â€¢ {r}</div>)}</div>
      </div>
    );
  };

  // ê¸‰ë“±í›„ì €ì  ì •ë³´ íŒ¨ë„
  const PostSurgePanel=({ps})=>{
    if(!ps||!ps.isPostSurge)return null;
    return(
      <div className="bg-gradient-to-r from-orange-900/50 to-red-900/50 rounded-lg p-2 mt-2 border border-orange-500/30">
        <div className="flex items-center gap-2 mb-1">
          <span className="text-sm font-bold">ğŸ”¥ ê¸‰ë“±í›„ì €ì  ë¶„ì„</span>
          <span className="text-orange-400 font-bold">{ps.score}ì </span>
        </div>
        <div className="grid grid-cols-2 gap-1 text-xs">
          <div className="bg-gray-800/50 rounded p-1"><span className="text-gray-400">6ê°œì›”ê³ ì ëŒ€ë¹„</span><div className="text-red-400 font-bold">-{ps.dropFrom6mHigh}%</div></div>
          <div className="bg-gray-800/50 rounded p-1"><span className="text-gray-400">3ê°œì›”ê³ ì ëŒ€ë¹„</span><div className="text-orange-400 font-bold">-{ps.dropFrom3mHigh}%</div></div>
          <div className="bg-gray-800/50 rounded p-1"><span className="text-gray-400">ë°˜ë“±ëª©í‘œê°€</span><div className="text-green-400 font-bold">{ps.recoveryTarget?.toLocaleString()}</div></div>
          <div className="bg-gray-800/50 rounded p-1"><span className="text-gray-400">ì €ì ëŒ€ë¹„</span><div className="text-blue-400 font-bold">+{ps.fromLow}%</div></div>
        </div>
        {ps.details?.length>0&&<div className="mt-1 text-[10px] text-gray-400">{ps.details.join(' | ')}</div>}
      </div>
    );
  };

  const NewsPanel=({name})=>{
    const nd=news[name];
    if(!nd)return null;
    return(
      <div className="bg-gray-800/50 rounded-lg p-2 mt-2">
        <div className="text-sm font-bold mb-1">ğŸ“° ë‰´ìŠ¤</div>
        {nd.slice(0,3).map((n,i)=>(
          <div key={i} className="flex items-start gap-1 py-0.5 border-b border-gray-700 last:border-0">
            <span className={`text-xs ${n.sent==='p'?'text-green-400':n.sent==='g'?'text-red-400':'text-gray-400'}`}>{n.sent==='p'?'ğŸ“ˆ':'ğŸ“‹'}</span>
            <div><div className="text-[10px]">{n.title}</div><div className="text-[9px] text-gray-500">{n.time}</div></div>
          </div>
        ))}
      </div>
    );
  };

  const MemoBox=({code})=>(<div className="mt-2"><div className="text-xs text-gray-400 mb-1">ğŸ’¬ ë©”ëª¨</div><textarea value={memos[code]||''} onChange={e=>saveMemo(code,e.target.value)} onClick={e=>e.stopPropagation()} className="w-full bg-gray-700 rounded p-2 text-xs h-14 resize-none" placeholder="ë©”ëª¨..."/></div>);

  const Card=({s,i,rank=true,isPort=false})=>(
    <div onClick={()=>{setSel(sel?.code===s.code?null:s);if(sel?.code!==s.code){loadChart(s.code);loadNews(s.name)}}} className="bg-gray-800 rounded-xl p-3 border border-gray-700 mb-2">
      <div className="flex justify-between items-start mb-2">
        <div className="flex items-center gap-2">
          {rank&&<span className="text-lg font-bold text-yellow-500">#{i+1}</span>}
          <div>
            <div className="font-bold text-sm flex items-center gap-1">
              {s.name}
              {s.postSurge?.isPostSurge&&<span className="text-orange-400 text-[10px]">ğŸ”¥ì €ì </span>}
            </div>
            <div className="text-gray-400 text-xs">{s.code}</div>
          </div>
        </div>
        <div className="flex items-center gap-1">
          <button onClick={e=>togFav(s,e)} className={`text-lg ${isFav(s.code)?'text-yellow-400':'text-gray-500'}`}>{isFav(s.code)?'â˜…':'â˜†'}</button>
          <button onClick={e=>{e.stopPropagation();addAlert(s)}} className="text-lg text-gray-500">ğŸ””</button>
          <button onClick={e=>{e.stopPropagation();addPort(s)}} className="text-lg text-gray-500">ğŸ’¼</button>
          {s.sig&&<SigBadge s={s.sig}/>}
        </div>
      </div>
      
      {isPort&&s.cur?(
        <div className="bg-gray-700/50 rounded-lg p-2 mb-2 text-xs">
          <div className="grid grid-cols-2 gap-1">
            <div>ë§¤ìˆ˜ê°€: {s.buy?.toLocaleString()}ì›</div><div>í˜„ì¬ê°€: {s.cur?.toLocaleString()}ì›</div>
            <div>ìˆ˜ëŸ‰: {s.qty}ì£¼</div><div>í‰ê°€ê¸ˆ: {s.total?.toLocaleString()}ì›</div>
          </div>
          <div className={`text-center font-bold mt-1 ${s.pnl>=0?'text-red-400':'text-blue-400'}`}>{s.pnl>=0?'+':''}{s.pnl}% ({s.amt>=0?'+':''}{s.amt?.toLocaleString()}ì›)</div>
        </div>
      ):s.price>0&&(
        <>
          <div className="grid grid-cols-2 gap-2 mb-2 text-xs">
            <div className="bg-gray-700/50 rounded p-2"><div className="text-gray-400">í˜„ì¬ê°€</div><div className="font-bold">{s.price?.toLocaleString()}ì›</div></div>
            <div className="bg-gray-700/50 rounded p-2"><div className="text-gray-400">ë“±ë½ë¥ </div><div className={`font-bold ${s.chg>=0?'text-red-400':'text-blue-400'}`}>{s.chg>=0?'+':''}{s.chg?.toFixed(2)}%</div></div>
          </div>
          <div className="grid grid-cols-4 gap-1 mb-1 text-xs">
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">RSI</div><div className={`font-bold ${s.rsi>70?'text-red-400':s.rsi<30?'text-blue-400':'text-green-400'}`}>{s.rsi}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">ì´í‰ì„ </div><div className={`font-bold text-[10px] ${s.ma==='ì •ë°°ì—´'?'text-green-400':s.ma==='ì—­ë°°ì—´'?'text-red-400':'text-purple-400'}`}>{s.ma}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">MACD</div><div className={`font-bold text-[10px] ${s.macd?.cross==='golden'?'text-green-400':'text-red-400'}`}>{s.macd?.cross==='golden'?'ê³¨ë“ ':'ë°ë“œ'}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[9px]">ê±°ë˜ëŸ‰</div><div className={`font-bold text-[10px] ${s.vol?.s==='í­ì¦'?'text-red-400':s.vol?.s==='ê¸‰ì¦'?'text-orange-400':'text-gray-400'}`}>{s.vol?.s}</div></div>
          </div>
          <div className="grid grid-cols-5 gap-1 mb-2 text-xs">
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[8px]">ìŠ¤í† ìº</div><div className={`font-bold text-[9px] ${s.stoch?.sig==='ê³¼ë§¤ìˆ˜'?'text-red-400':s.stoch?.sig==='ê³¼ë§¤ë„'?'text-blue-400':'text-gray-300'}`}>{s.stoch?.k}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[8px]">OBV</div><div className={`font-bold text-[9px] ${s.obv?.trend?.includes('ìƒìŠ¹')?'text-green-400':s.obv?.trend?.includes('í•˜ë½')?'text-red-400':'text-gray-300'}`}>{s.obv?.trend?.slice(0,2)}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[8px]">W%R</div><div className={`font-bold text-[9px] ${s.williams?.sig==='ê³¼ë§¤ìˆ˜'?'text-red-400':s.williams?.sig==='ê³¼ë§¤ë„'?'text-blue-400':'text-gray-300'}`}>{s.williams?.val}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[8px]">CCI</div><div className={`font-bold text-[9px] ${s.cci?.sig==='ê³¼ë§¤ìˆ˜'?'text-red-400':s.cci?.sig==='ê³¼ë§¤ë„'?'text-blue-400':'text-gray-300'}`}>{s.cci?.val}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><div className="text-gray-400 text-[8px]">ìº”ë“¤</div><div className={`font-bold text-[9px] ${s.cnd?.sig==='b'?'text-green-400':s.cnd?.sig==='s'?'text-red-400':'text-gray-300'}`}>{s.cnd?.p?.slice(0,2)||'-'}</div></div>
          </div>
          
          {/* ê¸‰ë“±í›„ì €ì  í‘œì‹œ */}
          {s.postSurge?.score>=30&&<div className="bg-orange-900/30 rounded px-2 py-1 mb-2 text-[10px]"><span className="text-orange-400 font-bold">ğŸ”¥ {s.postSurge.status}</span><span className="text-gray-400 ml-2">ê³ ì ëŒ€ë¹„ -{s.postSurge.dropFrom6mHigh}%</span></div>}
          
          <div className="flex gap-1 items-center">
            <span className="bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded-full text-[10px]">{s.strat}</span>
            {s.ai&&<button onClick={e=>{e.stopPropagation();setShowAI(showAI===s.code?null:s.code)}} className="text-purple-400 text-xs ml-auto">ğŸ¤–AI{showAI===s.code?'â–²':'â–¼'}</button>}
          </div>
          
          {showAI===s.code&&<AIPanel stock={s}/>}
          {showAI===s.code&&s.postSurge?.isPostSurge&&<PostSurgePanel ps={s.postSurge}/>}
        </>
      )}
      
      {sel?.code===s.code&&(
        <div className="mt-2 pt-2 border-t border-gray-700">
          <div className="flex gap-1 mb-2">{['w','m','q','h','y'].map(p=><button key={p} onClick={e=>{e.stopPropagation();setPeriod(p)}} className={`px-2 py-0.5 rounded text-[10px] ${period===p?'bg-blue-600':'bg-gray-700'}`}>{p==='w'?'1ì£¼':p==='m'?'1ì›”':p==='q'?'3ì›”':p==='h'?'6ì›”':'1ë…„'}</button>)}</div>
          {charts[s.code]?<><Chart_ data={charts[s.code]} name={s.name} period={period}/><VolChart data={charts[s.code]} period={period}/></>:<div className="h-32 flex items-center justify-center text-gray-400 text-sm">ì°¨íŠ¸ ë¡œë”©...</div>}
          <div className="grid grid-cols-2 gap-2 text-xs mt-2">
            <div className="bg-gray-700/30 rounded p-1"><span className="text-gray-400">52ì£¼ìµœê³ </span><div className="text-red-400 font-bold">{s.h52?.toLocaleString()}ì›</div></div>
            <div className="bg-gray-700/30 rounded p-1"><span className="text-gray-400">52ì£¼ìµœì €</span><div className="text-blue-400 font-bold">{s.l52?.toLocaleString()}ì›</div></div>
          </div>
          {s.postSurge?.isPostSurge&&<PostSurgePanel ps={s.postSurge}/>}
          <NewsPanel name={s.name}/>
          <MemoBox code={s.code}/>
        </div>
      )}
      <div className="text-center text-[10px] text-gray-500 mt-1">{sel?.code===s.code?'â–²ì ‘ê¸°':'â–¼ìƒì„¸+ì°¨íŠ¸+AI'}</div>
    </div>
  );

  const PortSum=()=>{
    if(tab!=='port'||!list.length||!list[0].total)return null;
    const inv=list.reduce((s,i)=>s+(i.buy||0)*(i.qty||0),0),val=list.reduce((s,i)=>s+(i.total||0),0),pnl=val-inv,rate=inv?(pnl/inv*100).toFixed(2):0;
    return <div className="bg-gradient-to-r from-green-800 to-blue-800 rounded-xl p-3 mb-3"><div className="text-xs text-gray-300">ì´ í‰ê°€ê¸ˆì•¡</div><div className="text-xl font-bold">{val.toLocaleString()}ì›</div><div className={`${pnl>=0?'text-red-300':'text-blue-300'}`}>{pnl>=0?'+':''}{pnl.toLocaleString()}ì› ({pnl>=0?'+':''}{rate}%)</div><div className="text-[10px] text-gray-400">íˆ¬ìì›ê¸ˆ: {inv.toLocaleString()}ì›</div></div>;
  };

  if(!logged)return(
    <div className={`min-h-screen flex items-center justify-center p-4 ${dark?'bg-gray-900':'bg-gray-100'}`}>
      <div className={`max-w-sm w-full ${dark?'bg-gray-800':'bg-white'} rounded-2xl p-5 shadow-xl`}>
        <h1 className="text-xl font-bold text-center mb-1">ğŸ‡°ğŸ‡· ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ Pro+</h1>
        <p className="text-gray-400 text-xs text-center mb-4">í•œêµ­íˆ¬ìì¦ê¶Œ KIS API + AIë¶„ì„</p>
        <div className="space-y-3">
          <input value={key} onChange={e=>setKey(e.target.value)} className={`w-full ${dark?'bg-gray-700':'bg-gray-100'} rounded-lg px-3 py-2`} placeholder="APP KEY"/>
          <input type="password" value={sec} onChange={e=>setSec(e.target.value)} className={`w-full ${dark?'bg-gray-700':'bg-gray-100'} rounded-lg px-3 py-2`} placeholder="APP SECRET"/>
          {err&&<div className="text-red-400 text-xs">{err}</div>}
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={save} onChange={e=>setSave(e.target.checked)}/>ğŸ” í‚¤ ì €ì¥</label>
          <button onClick={login} disabled={load} className="w-full bg-blue-600 py-3 rounded-lg font-bold disabled:opacity-50">{load?'ì—°ê²°ì¤‘...':'ğŸ”— ë¡œê·¸ì¸'}</button>
          <button onClick={()=>setDark(!dark)} className="w-full text-gray-400 text-xs py-1">{dark?'â˜€ï¸ ë¼ì´íŠ¸':'ğŸŒ™ ë‹¤í¬'} ëª¨ë“œ</button>
        </div>
      </div>
    </div>
  );

  return(
    <div className={`min-h-screen ${dark?'bg-gray-900 text-white':'bg-gray-100 text-gray-900'}`}>
      <div className="max-w-lg mx-auto p-3">
        <div className="bg-gradient-to-r from-blue-700 to-purple-700 rounded-xl p-3 mb-3">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="font-bold text-white text-sm">ğŸ‡°ğŸ‡· ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ Pro+</h1>
              <div className="flex items-center gap-2">{upd&&<p className="text-[10px] text-gray-300">{upd}</p>}{autoRefresh&&<span className="text-[10px] text-green-300 animate-pulse-slow">ğŸ”„{refreshInterval}ì´ˆ</span>}</div>
            </div>
            <button onClick={()=>{if(tab==='scan')scan();else if(tab==='fav')refreshFav();else if(tab==='port')refreshPort();else if(tab==='search')searchStock()}} disabled={load} className="bg-white text-purple-800 px-3 py-1.5 rounded-lg font-bold text-sm disabled:opacity-50">{load?'â³':'ğŸ”'}</button>
          </div>
        </div>
        
        {err&&<div className="bg-red-900/50 border border-red-500 rounded-lg p-2 mb-2 text-red-300 text-xs">{err}</div>}
        
        <div className="flex gap-1 mb-2 overflow-x-auto text-xs">
          {[{id:'scan',icon:'ğŸ”',lb:'ìŠ¤í¬ë¦¬ë‹'},{id:'fav',icon:'â­',lb:`ê´€ì‹¬(${favs.length})`},{id:'port',icon:'ğŸ’¼',lb:'í¬íŠ¸í´ë¦¬ì˜¤'},{id:'search',icon:'ğŸ”',lb:'ê²€ìƒ‰'},{id:'alert',icon:'ğŸ””',lb:'ì•Œë¦¼'},{id:'set',icon:'âš™ï¸',lb:'ì„¤ì •'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setList([]);setShowAI(null)}} className={`px-2 py-1.5 rounded-lg font-bold whitespace-nowrap ${tab===t.id?'bg-blue-600':'bg-gray-800'}`}>{t.icon}{t.lb}</button>)}
        </div>
        
        {tab==='scan'&&<>
          <div className="flex gap-1 mb-2">
            <button onClick={()=>setMode('day')} className={`flex-1 py-1.5 rounded-lg font-bold text-xs ${mode==='day'?'bg-orange-500':'bg-gray-800'}`}>ğŸ”¥ë°ì´</button>
            <button onClick={()=>setMode('swing')} className={`flex-1 py-1.5 rounded-lg font-bold text-xs ${mode==='swing'?'bg-purple-500':'bg-gray-800'}`}>ğŸ“ŠìŠ¤ìœ™</button>
            <button onClick={()=>setMode('bottom')} className={`flex-1 py-1.5 rounded-lg font-bold text-xs ${mode==='bottom'?'bg-orange-600':'bg-gray-800'}`}>ğŸ”¥ì €ì </button>
          </div>
          <div className="flex gap-1 mb-3">{[['low','ğŸª™ë™ì „ì£¼','green'],['mid','ğŸ’µì¤‘ê°€ì£¼','blue']].map(([p,l,c])=><button key={p} onClick={()=>setPrice(p)} className={`flex-1 py-1 rounded-lg font-bold text-xs ${price===p?`bg-${c}-600`:'bg-gray-800'}`}>{l}</button>)}</div>
          {mode==='bottom'&&<div className="bg-orange-900/30 rounded-lg p-2 mb-3 text-xs text-orange-300">ğŸ”¥ <b>ê¸‰ë“±í›„ì €ì </b>: 3~6ê°œì›”ë‚´ ê³ ì ëŒ€ë¹„ 30%ì´ìƒ í•˜ë½ í›„ ì €ì ê¶Œ ì¢…ëª©</div>}
        </>}
        
        {tab==='search'&&<div className="mb-3"><input value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==='Enter'&&searchStock()} className="w-full bg-gray-800 rounded-lg px-3 py-2 text-sm" placeholder="ì¢…ëª©ì½”ë“œ 6ìë¦¬ (ì˜ˆ:005930)"/><div className="text-[10px] text-gray-500 mt-1">ğŸ’¡ ì‚¼ì„±ì „ì:005930, SKí•˜ì´ë‹‰ìŠ¤:000660</div></div>}
        
        {tab==='alert'&&<div className="space-y-2">
          <div className="flex justify-between items-center p-3 bg-gray-800 rounded-lg"><span className="text-sm">ğŸ”” ì•Œë¦¼ í™œì„±í™”</span><button onClick={()=>setAlertOn(!alertOn)} className={`w-10 h-5 rounded-full ${alertOn?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full transform transition ${alertOn?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {!alerts.length?<div className="text-center py-6 text-gray-500 text-sm">ì„¤ì •ëœ ì•Œë¦¼ ì—†ìŒ</div>:alerts.map((a,i)=><div key={i} className="p-2 bg-gray-800 rounded-lg flex justify-between items-center text-sm"><div><div className="font-bold">{a.name}</div><div className="text-[10px] text-gray-400">{a.type==='target'?'ëª©í‘œê°€':a.type==='stop'?'ì†ì ˆê°€':a.type==='surge'?'ê¸‰ë“±':'ê¸‰ë½'} {a.val.toLocaleString()}{a.type==='target'||a.type==='stop'?'ì›':'%'}</div></div><div className="flex gap-2"><button onClick={()=>togAlert(i)} className={`w-8 h-4 rounded-full ${a.on?'bg-green-500':'bg-gray-600'}`}><div className={`w-3 h-3 bg-white rounded-full transform ${a.on?'translate-x-4':'translate-x-0.5'}`}/></button><button onClick={()=>delAlert(i)} className="text-red-400">ğŸ—‘</button></div></div>)}
        </div>}
        
        {tab==='set'&&<div className="space-y-2">
          <div className="flex justify-between items-center p-3 bg-gray-800 rounded-lg"><span className="text-sm">{dark?'ğŸŒ™ ë‹¤í¬':'â˜€ï¸ ë¼ì´íŠ¸'} ëª¨ë“œ</span><button onClick={()=>setDark(!dark)} className={`w-10 h-5 rounded-full ${dark?'bg-blue-500':'bg-yellow-500'}`}><div className={`w-4 h-4 bg-white rounded-full transform ${dark?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          <div className="flex justify-between items-center p-3 bg-gray-800 rounded-lg"><span className="text-sm">ğŸ”„ ìë™ìƒˆë¡œê³ ì¹¨</span><button onClick={()=>setAutoRefresh(!autoRefresh)} className={`w-10 h-5 rounded-full ${autoRefresh?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full transform ${autoRefresh?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {autoRefresh&&<div className="p-3 bg-gray-800 rounded-lg"><div className="text-sm mb-2">ì£¼ê¸°</div><div className="flex gap-2">{[30,60,120,300].map(s=><button key={s} onClick={()=>setRefreshInterval(s)} className={`flex-1 py-1 rounded text-xs ${refreshInterval===s?'bg-blue-600':'bg-gray-700'}`}>{s}ì´ˆ</button>)}</div></div>}
          <div className="p-3 bg-gray-800 rounded-lg text-sm"><div className="mb-2 font-bold">ğŸ’¾ ì €ì¥ ë°ì´í„°</div><div className="text-xs text-gray-400">ê´€ì‹¬: {favs.length} | í¬íŠ¸: {port.length} | ì•Œë¦¼: {alerts.length} | ë©”ëª¨: {Object.keys(memos).length}</div><button onClick={()=>{if(confirm('ëª¨ë“  ë°ì´í„° ì‚­ì œ?')){setFavs([]);setPort([]);setAlerts([]);setMemos({});localStorage.clear()}}} className="mt-2 w-full py-1.5 bg-red-600 rounded text-xs">ğŸ—‘ ì „ì²´ì‚­ì œ</button></div>
          <button onClick={logout} className="w-full py-2 bg-gray-700 rounded-lg text-sm">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>}
        
        <PortSum/>
        
        {list.length>0&&!load&&tab!=='alert'&&tab!=='set'&&<div>{list.map((s,i)=><Card key={s.code} s={s} i={i} rank={tab==='scan'} isPort={tab==='port'}/>)}</div>}
        
        {!list.length&&!load&&tab!=='alert'&&tab!=='set'&&<div className="text-center py-10"><div className="text-4xl mb-2">{tab==='scan'?'ğŸ“ˆ':tab==='fav'?'â­':tab==='port'?'ğŸ’¼':'ğŸ”'}</div><p className="text-gray-400 text-sm">{tab==='scan'?'ğŸ”ë²„íŠ¼ìœ¼ë¡œ ìŠ¤í¬ë¦¬ë‹':tab==='fav'?(favs.length?'ğŸ”ë²„íŠ¼ ì—…ë°ì´íŠ¸':'ê´€ì‹¬ì¢…ëª© ì¶”ê°€'):tab==='port'?(port.length?'ğŸ”ë²„íŠ¼ ì—…ë°ì´íŠ¸':'í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ê°€'):'ì¢…ëª©ì½”ë“œ ê²€ìƒ‰'}</p>
          {tab==='fav'&&favs.length>0&&<div className="mt-3 space-y-1">{favs.map(f=><div key={f.code} className="bg-gray-800 rounded p-2 flex justify-between text-sm"><span>{f.name}({f.code})</span><button onClick={()=>togFav(f)} className="text-red-400 text-xs">ì‚­ì œ</button></div>)}</div>}
          {tab==='port'&&port.length>0&&<div className="mt-3 space-y-1">{port.map(p=><div key={p.code} className="bg-gray-800 rounded p-2 flex justify-between text-sm"><span>{p.name}({p.code}) {p.qty}ì£¼</span><button onClick={()=>delPort(p.code)} className="text-red-400 text-xs">ì‚­ì œ</button></div>)}</div>}
        </div>}
        
        {load&&<div className="text-center py-10"><div className="text-4xl animate-bounce">ğŸ”</div><p className="text-gray-400 text-sm mt-2">{prog||'ë¶„ì„ì¤‘...'}</p></div>}
        
        <div className="mt-4 p-2 bg-gray-800 rounded-lg text-[9px] text-gray-500">âš ï¸íˆ¬ìì°¸ê³  | ğŸ¤–AI + RSI,MACD,ìŠ¤í† ìº,OBV,CCI,ë³¼ë¦°ì €,ìº”ë“¤ + ğŸ”¥ê¸‰ë“±í›„ì €ì </div>
      </div>
      
      {modal==='port'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-4 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-3">ğŸ’¼ í¬íŠ¸í´ë¦¬ì˜¤</h3><div className="text-sm mb-2">{form.name}({form.code})</div><input type="number" value={form.buy} onChange={e=>setForm({...form,buy:e.target.value})} className="w-full bg-gray-700 rounded px-3 py-2 mb-2" placeholder="ë§¤ìˆ˜ê°€"/><input type="number" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} className="w-full bg-gray-700 rounded px-3 py-2 mb-3" placeholder="ìˆ˜ëŸ‰"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded">ì·¨ì†Œ</button><button onClick={savePort} className="flex-1 py-2 bg-blue-600 rounded font-bold">ì €ì¥</button></div></div></div>}
      
      {modal==='alert'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-4 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-3">ğŸ”” ì•Œë¦¼</h3><div className="text-sm mb-2">{form.name}({form.code})</div><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})} className="w-full bg-gray-700 rounded px-3 py-2 mb-2"><option value="target">ëª©í‘œê°€</option><option value="stop">ì†ì ˆê°€</option><option value="surge">ê¸‰ë“±%</option><option value="plunge">ê¸‰ë½%</option></select><input type="number" value={form.val} onChange={e=>setForm({...form,val:e.target.value})} className="w-full bg-gray-700 rounded px-3 py-2 mb-3" placeholder={form.type==='target'||form.type==='stop'?'ê°€ê²©(ì›)':'%'}/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded">ì·¨ì†Œ</button><button onClick={saveAlert} className="flex-1 py-2 bg-blue-600 rounded font-bold">ì €ì¥</button></div></div></div>}
    </div>
  );
};

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
