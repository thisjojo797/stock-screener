<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ Ultimate</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
    body{margin:0;padding:0;overscroll-behavior:none;font-family:system-ui,sans-serif}
    .scroll-hide::-webkit-scrollbar{display:none}
  </style>
</head>
<body class="bg-gray-900 text-white">
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef}=React;
const API=window.location.origin+'/api';

const calcRSI=(p,n=14)=>{if(p.length<n+1)return 50;let g=0,l=0;for(let i=1;i<=n;i++){const d=p[i-1]-p[i];d>0?g+=d:l-=d}return l===0?100:Math.round(100-100/(1+g/l))};
const calcMACD=(p)=>{if(p.length<26)return{c:'n'};const ema=(d,n)=>{let e=d.slice(0,n).reduce((a,b)=>a+b)/n;for(let i=n;i<d.length;i++)e=d[i]*(2/(n+1))+e*(1-2/(n+1));return e};const m=ema(p,12)-ema(p,26);return{c:m>0?'g':'d',v:m.toFixed(0)}};
const calcBB=(p,n=20)=>{if(p.length<n)return{pos:'m',pB:50};const s=p.slice(0,n),avg=s.reduce((a,b)=>a+b)/n,std=Math.sqrt(s.reduce((x,v)=>x+(v-avg)**2,0)/n),u=avg+std*2,l=avg-std*2;return{pos:p[0]>=u?'h':p[0]<=l?'l':'m',u,l,avg,w:((u-l)/avg*100).toFixed(1),pB:std?Math.round((p[0]-l)/(u-l)*100):50}};
const calcStoch=(d,k=14)=>{if(d.length<k)return{k:50,s:'ì¤‘ë¦½'};const hh=Math.max(...d.slice(0,k).map(x=>x.h)),ll=Math.min(...d.slice(0,k).map(x=>x.l)),kV=hh===ll?50:(d[0].c-ll)/(hh-ll)*100;return{k:Math.round(kV),s:kV>80?'ê³¼ë§¤ìˆ˜':kV<20?'ê³¼ë§¤ë„':'ì¤‘ë¦½'}};
const calcOBV=(d)=>{if(d.length<10)return{t:'ë¶€ì¡±'};let t5=0;for(let i=1;i<5&&i<d.length;i++)d[i-1].c>d[i].c?t5+=d[i-1].v:d[i-1].c<d[i].c&&(t5-=d[i-1].v);return{t:t5>0&&d[0].c>d[4]?.c?'ìƒìŠ¹í™•ì¸':t5<0?'í•˜ë½í™•ì¸':'íš¡ë³´'}};
const calcVol=(v)=>{if(v.length<20)return{r:1,s:'ë³´í†µ'};const avg=v.slice(0,20).reduce((a,b)=>a+b)/20,r=v[0]/avg;return{r:r.toFixed(1),s:r>=3?'í­ì¦':r>=2?'ê¸‰ì¦':r>=1.5?'ì¦ê°€':'ë³´í†µ'}};
const calcADX=(d,n=14)=>{if(d.length<n*2)return{v:25,t:'ì¤‘ë¦½'};return{v:25,t:'ì¶”ì„¸'}};
const calcATR=(d,n=14)=>{if(d.length<n)return 0;let tr=0;for(let i=0;i<n;i++)tr+=Math.max(d[i].h-d[i].l,Math.abs(d[i].h-(d[i+1]?.c||d[i].c)));return Math.round(tr/n)};
const getMA=(p)=>{if(p.length<60)return{st:'ë¶€ì¡±'};const m5=p.slice(0,5).reduce((a,b)=>a+b)/5,m20=p.slice(0,20).reduce((a,b)=>a+b)/20,m60=p.slice(0,60).reduce((a,b)=>a+b)/60;return{st:m5>m20&&m20>m60?'ì •ë°°ì—´':m5<m20&&m20<m60?'ì—­ë°°ì—´':p[0]>m60?'60ì¼â†‘':'í˜¼ì¡°',m5,m20,m60}};
const detectCnd=(c)=>{if(c.length<2)return{p:'ì—†ìŒ',s:'n'};const[t,y]=c,b=t.c-t.o,r=t.h-t.l,ls=Math.min(t.o,t.c)-t.l;if(ls>Math.abs(b)*2)return{p:'ë§ì¹˜í˜•',s:'b'};if(Math.abs(b)<r*.1)return{p:'ë„ì§€',s:'n'};return{p:'ì—†ìŒ',s:'n'}};

const calcIchi=(d)=>{
  if(d.length<52)return null;
  const tenkan=(Math.max(...d.slice(0,9).map(x=>x.h))+Math.min(...d.slice(0,9).map(x=>x.l)))/2;
  const kijun=(Math.max(...d.slice(0,26).map(x=>x.h))+Math.min(...d.slice(0,26).map(x=>x.l)))/2;
  const spanA=(tenkan+kijun)/2,spanB=(Math.max(...d.slice(0,52).map(x=>x.h))+Math.min(...d.slice(0,52).map(x=>x.l)))/2;
  const price=d[0].c;
  let signal='ì¤‘ë¦½';
  if(price>spanA&&price>spanB&&tenkan>kijun)signal='ê°•í•œë§¤ìˆ˜';
  else if(price>Math.max(spanA,spanB))signal='ë§¤ìˆ˜';
  else if(price<Math.min(spanA,spanB))signal='ë§¤ë„';
  return{tenkan:Math.round(tenkan),kijun:Math.round(kijun),spanA:Math.round(spanA),spanB:Math.round(spanB),signal};
};

const detectPattern=(d)=>{
  if(d.length<30)return{pattern:'ì—†ìŒ',type:'n'};
  const lows=d.slice(0,30).map(x=>x.l),highs=d.slice(0,30).map(x=>x.h);
  const minIdx=lows.indexOf(Math.min(...lows));
  if(minIdx>5&&minIdx<25){
    const left=Math.min(...lows.slice(0,minIdx)),right=Math.min(...lows.slice(minIdx));
    if(Math.abs(left-right)/left<0.03)return{pattern:'ë”ë¸”ë°”í…€',type:'b',desc:'Wìí˜• ë°˜ë“±'};
  }
  return{pattern:'ì—†ìŒ',type:'n'};
};

const calcPostSurge=(d)=>{
  if(d.length<60)return{is:false,sc:0};
  const p=d.map(x=>x.c),cur=p[0],h3m=Math.max(...p.slice(0,60)),h6m=Math.max(...p.slice(0,Math.min(120,p.length))),l3m=Math.min(...p.slice(0,60));
  const d6=((h6m-cur)/h6m*100).toFixed(1);
  let sc=0,dt=[];
  if(d6>30){sc+=30;dt.push(`6M-${d6}%`)}
  if((cur-l3m)/l3m*100<10){sc+=25;dt.push('ì €ì ê·¼ì²˜')}
  return{is:sc>=50,sc,dt,d6:+d6,tg:Math.round(cur*1.3),rc:Math.round(h3m*.7)};
};

const getBBStrat=(bb)=>{
  if(!bb)return{s:'ê´€ë§',d:''};
  if(bb.pB<=20)return{s:'ë§¤ìˆ˜',d:'í•˜ë‹¨ë°˜ë“±'};
  if(bb.pB>=80)return{s:'ìµì ˆ',d:'ìƒë‹¨ì ‘ê·¼'};
  if(+bb.w<10)return{s:'ëŒíŒŒëŒ€ê¸°',d:'ìŠ¤í€´ì¦ˆ'};
  return{s:'ê´€ë§',d:'ì¤‘ë¦½'};
};

const calcSR=(d)=>{
  if(d.length<20)return{sup:[],res:[]};
  const h=d.slice(0,60).map(x=>x.h).sort((a,b)=>b-a),l=d.slice(0,60).map(x=>x.l).sort((a,b)=>a-b);
  return{res:[h[0],h[5]],sup:[l[0],l[5]]};
};

const calcFib=(d)=>{
  if(d.length<20)return null;
  const h=Math.max(...d.slice(0,60).map(x=>x.h)),l=Math.min(...d.slice(0,60).map(x=>x.l)),df=h-l;
  return{l0:h,l382:h-df*.382,l50:h-df*.5,l618:h-df*.618,l100:l};
};

const calcAI=(s)=>{
  let sc=0,rs=[];
  const{rsi,ma,macd,bb,stoch,obv,vol,cnd,ps,bbS,ichi,ptn,inv}=s;
  if(rsi<30){sc+=15;rs.push('RSIê³¼ë§¤ë„')}else if(rsi>70){sc-=15;rs.push('RSIê³¼ë§¤ìˆ˜')}
  if(ma?.st==='ì •ë°°ì—´'){sc+=20;rs.push('ì •ë°°ì—´')}else if(ma?.st==='ì—­ë°°ì—´'){sc-=20;rs.push('ì—­ë°°ì—´')}
  if(macd?.c==='g'){sc+=15;rs.push('MACDê³¨ë“ ')}else if(macd?.c==='d'){sc-=10}
  if(bb?.pos==='l'){sc+=12;rs.push('BBí•˜ë‹¨')}else if(bb?.pos==='h'){sc-=10}
  if(bbS?.s==='ë§¤ìˆ˜'){sc+=10;rs.push('BBë§¤ìˆ˜')}
  if(stoch?.s==='ê³¼ë§¤ë„'){sc+=8}
  if(obv?.t?.includes('ìƒìŠ¹')){sc+=10;rs.push('OBVìƒìŠ¹')}
  if(vol?.s==='í­ì¦'){sc+=8;rs.push('ê±°ë˜ëŸ‰í­ì¦')}
  if(cnd?.s==='b'){sc+=8;rs.push('ìƒìŠ¹ìº”ë“¤')}
  if(ps?.is){sc+=25;rs.unshift('ğŸ”¥ê¸‰ë“±í›„ì €ì ')}
  if(ichi?.signal?.includes('ë§¤ìˆ˜')){sc+=10;rs.push('ì¼ëª©'+ichi.signal)}
  if(ptn?.type==='b'){sc+=15;rs.push('ğŸ“Š'+ptn.pattern)}
  if(inv?.fBuy>0){sc+=10;rs.push('ì™¸êµ­ì¸ë§¤ìˆ˜')}
  if(inv?.iBuy>0){sc+=8;rs.push('ê¸°ê´€ë§¤ìˆ˜')}
  
  let act='âšªê´€ë§',conf=50,risk='ì¤‘ê°„';
  if(sc>=40){act='ğŸŸ¢ì ê·¹ë§¤ìˆ˜';conf=Math.min(95,60+sc)}
  else if(sc>=20){act='ğŸ”µë§¤ìˆ˜ê³ ë ¤';conf=Math.min(85,50+sc)}
  else if(sc<=-30){act='ğŸ”´ë§¤ë„ê³ ë ¤';conf=Math.min(85,50-sc)}
  
  if(vol?.s==='í­ì¦')risk='ë†’ìŒ';else if(ma?.st==='ì •ë°°ì—´'&&rsi>40&&rsi<60)risk='ë‚®ìŒ';
  const pr=s.price||0;
  let tg=Math.round(pr*(sc>0?1.1:.95)),sl=Math.round(pr*(sc>0?.95:1.05));
  if(ps?.is){tg=ps.rc;sl=Math.round(pr*.93)}
  return{sc,act,conf,risk,tg,sl,rs:rs.slice(0,6)};
};

const getStrat=(s)=>{
  const{ps,ptn,bbS,ichi,macd,vol,ma,rsi,chg}=s;
  if(ps?.sc>=70)return'ğŸ”¥ê¸‰ë“±í›„ì €ì ';
  if(ptn?.type==='b')return'ğŸ“Š'+ptn.pattern;
  if(bbS?.s==='ë§¤ìˆ˜')return'ğŸ“ŠBBë°˜ë“±';
  if(ichi?.signal==='ê°•í•œë§¤ìˆ˜')return'â˜ï¸ì¼ëª©ë§¤ìˆ˜';
  if(chg>10&&vol?.s==='í­ì¦')return'ğŸ”¥ë‰´ìŠ¤ë§¤ë§¤';
  if(macd?.c==='g')return'ğŸ“ˆMACDê³¨ë“ ';
  if(ma?.st==='ì •ë°°ì—´')return'ğŸ“Šì¶”ì„¸ë§¤ë§¤';
  if(rsi<30)return'ğŸ’¡ì—­ë°œìƒ';
  return'ğŸ‘€ê´€ë§';
};

const getSig=(s)=>{const ai=s.ai||calcAI(s);return ai.sc>=40?'ê°•ë ¥ë§¤ìˆ˜':ai.sc>=20?'ë§¤ìˆ˜':ai.sc<=-30?'ë§¤ë„':'ê´€ë§'};
const fmtN=n=>n?.toLocaleString()||'0';
const fmtP=n=>n>=0?'+'+n.toFixed(2)+'%':n.toFixed(2)+'%';
const calcDCA=(b,q,a,aq)=>({avg:Math.round((b*q+a*aq)/(q+aq)),tq:q+aq});
const calcRR=(e,t,s)=>{const rw=Math.abs(t-e),rs=Math.abs(e-s);return rs?(rw/rs).toFixed(2):0};
const calcPos=(cap,rsk,e,s)=>{const ra=cap*(rsk/100),rps=Math.abs(e-s);return rps?Math.floor(ra/rps):0};

const PriceChart=({data,period,showBB})=>{
  const ref=useRef(),ch=useRef();
  useEffect(()=>{
    if(!ref.current||!data?.length)return;
    ch.current?.destroy();
    const days={w:7,m:30,q:60,h:120,y:250}[period]||60;
    const d=data.slice(0,days),lb=d.map(x=>x.dt).reverse(),pr=d.map(x=>x.c).reverse();
    const m5=[],m20=[],bbU=[],bbL=[];
    for(let i=0;i<pr.length;i++){
      m5.push(i>=4?pr.slice(i-4,i+1).reduce((a,b)=>a+b)/5:null);
      m20.push(i>=19?pr.slice(i-19,i+1).reduce((a,b)=>a+b)/20:null);
      if(showBB&&i>=19){const s=pr.slice(i-19,i+1),av=s.reduce((a,b)=>a+b)/20,st=Math.sqrt(s.reduce((x,v)=>x+(v-av)**2,0)/20);bbU.push(av+st*2);bbL.push(av-st*2)}else{bbU.push(null);bbL.push(null)}
    }
    const ds=[{label:'ê°€ê²©',data:pr,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.1,pointRadius:0,borderWidth:2},{label:'MA5',data:m5,borderColor:'#f59e0b',borderWidth:1,pointRadius:0},{label:'MA20',data:m20,borderColor:'#ef4444',borderWidth:1,pointRadius:0}];
    if(showBB){ds.push({label:'BBìƒ',data:bbU,borderColor:'#6b7280',borderWidth:1,pointRadius:0},{label:'BBí•˜',data:bbL,borderColor:'#6b7280',borderWidth:1,pointRadius:0,fill:'-1',backgroundColor:'rgba(107,114,128,.1)'})}
    ch.current=new window.Chart(ref.current,{type:'line',data:{labels:lb,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{color:'#9ca3af',font:{size:7},boxWidth:6}}},scales:{x:{ticks:{color:'#6b7280',maxTicksLimit:5,font:{size:6}},grid:{color:'#374151'}},y:{ticks:{color:'#6b7280',font:{size:6}},grid:{color:'#374151'}}}}});
    return()=>ch.current?.destroy();
  },[data,period,showBB]);
  return<div className="h-32"><canvas ref={ref}/></div>;
};

const VolChart=({data,period})=>{
  const ref=useRef(),ch=useRef();
  useEffect(()=>{
    if(!ref.current||!data?.length)return;
    ch.current?.destroy();
    const days={w:7,m:30,q:60,h:120,y:250}[period]||60;
    const d=data.slice(0,days),lb=d.map(x=>x.dt).reverse(),vl=d.map(x=>x.v/1e6).reverse(),cl=d.map(x=>x.c>=x.o?'rgba(239,68,68,.7)':'rgba(59,130,246,.7)').reverse();
    ch.current=new window.Chart(ref.current,{type:'bar',data:{labels:lb,datasets:[{data:vl,backgroundColor:cl}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{ticks:{color:'#6b7280',font:{size:5}},grid:{color:'#374151'}}}}});
    return()=>ch.current?.destroy();
  },[data,period]);
  return<div className="h-12"><canvas ref={ref}/></div>;
};

const App=()=>{
  const[key,setKey]=useState(localStorage.getItem('k')||'');
  const[sec,setSec]=useState(localStorage.getItem('s')||'');
  const[save,setSave]=useState(localStorage.getItem('sv')==='1');
  const[logged,setLogged]=useState(false);
  const[tab,setTab]=useState('scan');
  const[mode,setMode]=useState('day');
  const[price,setPrice]=useState('all');
  const[load,setLoad]=useState(false);
  const[err,setErr]=useState('');
  const[list,setList]=useState([]);
  const[sel,setSel]=useState(null);
  const[upd,setUpd]=useState('');
  const[prog,setProg]=useState('');
  const[period,setPeriod]=useState('q');
  const[showBB,setShowBB]=useState(true);
  const[favs,setFavs]=useState(()=>JSON.parse(localStorage.getItem('fav')||'[]'));
  const[port,setPort]=useState(()=>JSON.parse(localStorage.getItem('port')||'[]'));
  const[alerts,setAlerts]=useState(()=>JSON.parse(localStorage.getItem('alrt')||'[]'));
  const[alertOn,setAlertOn]=useState(localStorage.getItem('alrtOn')!=='0');
  const[dark,setDark]=useState(true);
  const[charts,setCharts]=useState({});
  const[modal,setModal]=useState(null);
  const[form,setForm]=useState({});
  const[search,setSearch]=useState('');
  const[memos,setMemos]=useState(()=>JSON.parse(localStorage.getItem('memos')||'{}'));
  const[autoRef,setAutoRef]=useState(localStorage.getItem('autoRef')==='1');
  const[refInt,setRefInt]=useState(+(localStorage.getItem('refInt')||'60'));
  const[showAI,setShowAI]=useState(null);
  const[invData,setInvData]=useState({});
  const[calcMod,setCalcMod]=useState(null);
  const[compare,setCompare]=useState([]);

  useEffect(()=>{localStorage.setItem('fav',JSON.stringify(favs))},[favs]);
  useEffect(()=>{localStorage.setItem('port',JSON.stringify(port))},[port]);
  useEffect(()=>{localStorage.setItem('alrt',JSON.stringify(alerts))},[alerts]);
  useEffect(()=>{localStorage.setItem('alrtOn',alertOn?'1':'0')},[alertOn]);
  useEffect(()=>{localStorage.setItem('memos',JSON.stringify(memos))},[memos]);
  useEffect(()=>{localStorage.setItem('autoRef',autoRef?'1':'0')},[autoRef]);
  useEffect(()=>{localStorage.setItem('refInt',refInt)},[refInt]);
  useEffect(()=>{if(save&&key&&sec)login()},[]);

  useEffect(()=>{
    if(!autoRef||!logged)return;
    const iv=setInterval(()=>{if(tab==='scan')scan();else if(tab==='fav')refreshFav()},refInt*1000);
    return()=>clearInterval(iv);
  },[autoRef,refInt,logged,tab]);

  const login=async()=>{
    if(!key||!sec){setErr('KEY/SECRET í•„ìš”');return}
    setLoad(true);setErr('');
    try{
      const r=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec})});
      if(r.ok){if(save){localStorage.setItem('k',key);localStorage.setItem('s',sec);localStorage.setItem('sv','1')}setLogged(true);Notification.permission==='default'&&Notification.requestPermission()}
      else setErr((await r.json()).error||'ì‹¤íŒ¨');
    }catch(e){setErr(e.message)}
    setLoad(false);
  };

  const logout=()=>{setLogged(false);setList([]);['k','s','sv'].forEach(x=>localStorage.removeItem(x));setKey('');setSec('')};

  const loadChart=async(code)=>{
    if(charts[code])return charts[code];
    try{
      const r=await fetch(API+'/daily-chart',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:code})});
      const d=await r.json();
      if(d.success&&d.data){
        const f=d.data.map(x=>({dt:x.stck_bsop_date?.slice(4,6)+'/'+x.stck_bsop_date?.slice(6,8),o:+x.stck_oprc,h:+x.stck_hgpr,l:+x.stck_lwpr,c:+x.stck_clpr,v:+x.acml_vol})).filter(x=>x.c>0);
        setCharts(p=>({...p,[code]:f}));return f;
      }
    }catch{}return[];
  };

  const loadInvestor=async(code)=>{
    try{
      const r=await fetch(API+'/investor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:code})});
      const d=await r.json();
      if(d.success&&d.data?.length){
        const t=d.data[0];
        const inv={fBuy:+t.frgn_ntby_qty||0,iBuy:+t.orgn_ntby_qty||0,pBuy:+t.prsn_ntby_qty||0};
        setInvData(p=>({...p,[code]:inv}));
        return inv;
      }
    }catch{}return{fBuy:0,iBuy:0,pBuy:0};
  };

  const analyze=async(code,name,rawData)=>{
    const ch=rawData||await loadChart(code);
    if(!ch.length)return{error:true};
    const p=ch.map(x=>x.c),v=ch.map(x=>x.v);
    const rsi=calcRSI(p),ma=getMA(p),macd=calcMACD(p),bb=calcBB(p);
    const stoch=calcStoch(ch),obv=calcOBV(ch),vol=calcVol(v),cnd=detectCnd(ch);
    const ps=calcPostSurge(ch),bbS=getBBStrat(bb),sr=calcSR(ch),fib=calcFib(ch);
    const ichi=calcIchi(ch),ptn=detectPattern(ch),adx=calcADX(ch),atr=calcATR(ch);
    const inv=await loadInvestor(code);
    const result={rsi,ma,macd,bb,stoch,obv,vol,cnd,ps,bbS,sr,fib,ichi,ptn,adx,atr,inv};
    result.ai=calcAI(result);
    result.strat=getStrat(result);
    result.sig=getSig(result);
    return result;
  };

  const scan=async()=>{
    setLoad(true);setErr('');setProg('ì¡°íšŒì¤‘...');
    try{
      const results={low:[],mid:[]};
      setProg('ë™ì „ì£¼...');
      const[vL,cL]=await Promise.all([
        fetch(API+'/volume-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'10',priceMax:'999'})}).then(r=>r.json()),
        fetch(API+'/change-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'10',priceMax:'999',isUp:true})}).then(r=>r.json())
      ]);
      const mL=new Map();[...(vL.data||[]),...(cL.data||[])].forEach(s=>{const c=s.mksc_shrn_iscd||s.stck_shrn_iscd;c&&!mL.has(c)&&mL.set(c,s)});
      const tL=Array.from(mL.values()).slice(0,15);
      for(let i=0;i<tL.length;i++){
        const s=tL[i],code=s.mksc_shrn_iscd||s.stck_shrn_iscd;
        setProg(`ë™ì „ì£¼(${i+1}/${tL.length}) ${s.hts_kor_isnm}`);
        await new Promise(r=>setTimeout(r,150));
        const ch=await loadChart(code),a=await analyze(code,s.hts_kor_isnm,ch);
        if(!a.error)results.low.push({code,name:s.hts_kor_isnm,price:+s.stck_prpr||0,chg:+s.prdy_ctrt||0,volume:+s.acml_vol||0,h52:+s.w52_hgpr||0,l52:+s.w52_lwpr||0,type:'ë™ì „ì£¼',...a});
      }
      setProg('ì¤‘ê°€ì£¼...');
      const[vM,cM]=await Promise.all([
        fetch(API+'/volume-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'1000',priceMax:'9999'})}).then(r=>r.json()),
        fetch(API+'/change-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'1000',priceMax:'9999',isUp:true})}).then(r=>r.json())
      ]);
      const mM=new Map();[...(vM.data||[]),...(cM.data||[])].forEach(s=>{const c=s.mksc_shrn_iscd||s.stck_shrn_iscd;c&&!mM.has(c)&&mM.set(c,s)});
      const tM=Array.from(mM.values()).slice(0,15);
      for(let i=0;i<tM.length;i++){
        const s=tM[i],code=s.mksc_shrn_iscd||s.stck_shrn_iscd;
        setProg(`ì¤‘ê°€ì£¼(${i+1}/${tM.length}) ${s.hts_kor_isnm}`);
        await new Promise(r=>setTimeout(r,150));
        const ch=await loadChart(code),a=await analyze(code,s.hts_kor_isnm,ch);
        if(!a.error)results.mid.push({code,name:s.hts_kor_isnm,price:+s.stck_prpr||0,chg:+s.prdy_ctrt||0,volume:+s.acml_vol||0,h52:+s.w52_hgpr||0,l52:+s.w52_lwpr||0,type:'ì¤‘ê°€ì£¼',...a});
      }
      const sortFn=l=>{
        if(mode==='day')return l.sort((a,b)=>(b.chg*2+b.volume/1e6)-(a.chg*2+a.volume/1e6));
        if(mode==='swing')return l.sort((a,b)=>(b.ai?.sc||0)-(a.ai?.sc||0));
        if(mode==='bottom')return l.filter(x=>x.ps?.sc>=30).sort((a,b)=>(b.ps?.sc||0)-(a.ps?.sc||0));
        if(mode==='bb')return l.filter(x=>x.bbS?.s==='ë§¤ìˆ˜'||x.bbS?.s==='ëŒíŒŒëŒ€ê¸°').sort((a,b)=>(b.ai?.sc||0)-(a.ai?.sc||0));
        if(mode==='pattern')return l.filter(x=>x.ptn?.type!=='n').sort((a,b)=>(b.ai?.sc||0)-(a.ai?.sc||0));
        if(mode==='ichi')return l.filter(x=>x.ichi?.signal?.includes('ë§¤ìˆ˜')).sort((a,b)=>(b.ai?.sc||0)-(a.ai?.sc||0));
        return l;
      };
      const sL=sortFn([...results.low]).slice(0,10),sM=sortFn([...results.mid]).slice(0,10);
      setList(price==='low'?sL:price==='mid'?sM:[...sL,...sM]);
      setUpd(new Date().toLocaleString('ko-KR'));
    }catch(e){setErr(e.message)}
    setLoad(false);setProg('');
  };

  const refreshFav=async()=>{
    if(!favs.length)return;setLoad(true);setProg('ê´€ì‹¬ì¢…ëª©...');
    const result=[];
    for(let i=0;i<favs.length;i++){
      const f=favs[i];setProg(`${i+1}/${favs.length} ${f.name}`);
      await new Promise(r=>setTimeout(r,150));
      try{
        const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:f.code})}).then(r=>r.json());
        const ch=await loadChart(f.code),a=await analyze(f.code,f.name,ch);
        result.push({...f,price:+pr.data?.stck_prpr||0,chg:+pr.data?.prdy_ctrt||0,volume:+pr.data?.acml_vol||0,...a});
      }catch{result.push({...f,error:true})}
    }
    setList(result);setUpd(new Date().toLocaleString('ko-KR'));setLoad(false);setProg('');
  };

  const refreshPort=async()=>{
    if(!port.length)return;setLoad(true);setProg('í¬íŠ¸í´ë¦¬ì˜¤...');
    const result=[];
    for(let i=0;i<port.length;i++){
      const p=port[i];setProg(`${i+1}/${port.length} ${p.name}`);
      try{
        const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:p.code})}).then(r=>r.json());
        const cur=+pr.data?.stck_prpr||0,pnl=((cur-p.buy)/p.buy*100).toFixed(2);
        result.push({...p,cur,chg:+pr.data?.prdy_ctrt||0,pnl:+pnl,amt:(cur-p.buy)*p.qty,total:cur*p.qty});
      }catch{result.push({...p,error:true})}
    }
    setList(result);setUpd(new Date().toLocaleString('ko-KR'));setLoad(false);setProg('');
  };

  const searchStock=async()=>{
    if(!search.trim())return;setLoad(true);
    try{
      const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:search})}).then(r=>r.json());
      if(pr.success&&pr.data){
        const ch=await loadChart(search),a=await analyze(search,pr.data.hts_kor_isnm||search,ch);
        setList([{code:search,name:pr.data.hts_kor_isnm||search,price:+pr.data.stck_prpr||0,chg:+pr.data.prdy_ctrt||0,volume:+pr.data.acml_vol||0,...a}]);
      }else setErr('ì¢…ëª©ì—†ìŒ');
    }catch(e){setErr(e.message)}
    setLoad(false);
  };

  const isFav=c=>favs.some(f=>f.code===c);
  const togFav=(s,e)=>{e?.stopPropagation();setFavs(isFav(s.code)?favs.filter(f=>f.code!==s.code):[...favs,{code:s.code,name:s.name}])};
  const addPort=s=>{setForm({code:s.code,name:s.name,buy:s.price||s.cur,qty:''});setModal('port')};
  const savePort=()=>{if(!form.buy||!form.qty)return;const ex=port.findIndex(p=>p.code===form.code);if(ex>=0){const o=port[ex],tq=o.qty+ +form.qty,av=Math.round((o.buy*o.qty+ +form.buy*+form.qty)/tq);setPort(port.map((p,i)=>i===ex?{...o,buy:av,qty:tq}:p))}else setPort([...port,{code:form.code,name:form.name,buy:+form.buy,qty:+form.qty}]);setModal(null)};
  const delPort=c=>setPort(port.filter(p=>p.code!==c));
  const addAlert=s=>{setForm({code:s.code,name:s.name,type:'target',val:''});setModal('alert')};
  const saveAlert=()=>{if(!form.val)return;setAlerts([...alerts,{...form,val:+form.val,on:true}]);setModal(null)};
  const delAlert=i=>setAlerts(alerts.filter((_,j)=>j!==i));
  const togAlert=i=>{const a=[...alerts];a[i].on=!a[i].on;setAlerts(a)};
  const saveMemo=(code,text)=>setMemos({...memos,[code]:text});
  const togCompare=s=>{compare.find(c=>c.code===s.code)?setCompare(compare.filter(c=>c.code!==s.code)):compare.length<3&&setCompare([...compare,s])};
  
  const exportCSV=(data,fn)=>{
    const csv=data.map(r=>Object.values(r).join(',')).join('\n');
    const blob=new Blob(['\ufeff'+csv],{type:'text/csv'});
    const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=fn;link.click();
  };
  const backup=()=>{
    const data={favs,port,alerts,memos};
    const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
    const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='backup.json';link.click();
  };
  const restore=(e)=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);d.favs&&setFavs(d.favs);d.port&&setPort(d.port);d.alerts&&setAlerts(d.alerts);d.memos&&setMemos(d.memos);alert('ë³µì›ì™„ë£Œ!')}catch{alert('ì‹¤íŒ¨')}};
    reader.readAsText(file);
  };

  useEffect(()=>{
    if(!alertOn||!logged)return;
    const chk=async()=>{
      for(const a of alerts){
        if(!a.on)continue;
        try{
          const r=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:a.code})}).then(r=>r.json());
          const cur=+r.data?.stck_prpr||0,chg=+r.data?.prdy_ctrt||0;
          let fire=false,msg='';
          if(a.type==='target'&&cur>=a.val){fire=true;msg=`${a.name} ëª©í‘œê°€!`}
          else if(a.type==='stop'&&cur<=a.val){fire=true;msg=`${a.name} ì†ì ˆê°€!`}
          else if(a.type==='surge'&&chg>=a.val){fire=true;msg=`${a.name} +${chg}%!`}
          if(fire&&Notification.permission==='granted')new Notification('ğŸ“ˆ',{body:msg});
        }catch{}
      }
    };
    const iv=setInterval(chk,60000);return()=>clearInterval(iv);
  },[alerts,alertOn,logged]);

  const SigBadge=({s})=>{const c={'ê°•ë ¥ë§¤ìˆ˜':'bg-green-600','ë§¤ìˆ˜':'bg-green-500','ê´€ë§':'bg-yellow-500 text-black','ë§¤ë„':'bg-red-500'};return<span className={`px-1 py-0.5 rounded text-[9px] font-bold ${c[s]||'bg-gray-500'}`}>{s}</span>};

  const AIPanel=({s})=>{
    const ai=s.ai;if(!ai)return null;
    return(
      <div className="bg-purple-900/40 rounded p-2 mt-1 border border-purple-500/30 text-[10px]">
        <div className="flex justify-between mb-1"><span className="font-bold">ğŸ¤–AI</span><span className={ai.sc>0?'text-green-400':'text-red-400'}>{ai.sc>0?'+':''}{ai.sc}</span></div>
        <div className="text-center mb-1"><div className="text-sm font-bold">{ai.act}</div><div className="text-gray-400">ì‹ ë¢°ë„{ai.conf}%</div></div>
        <div className="grid grid-cols-3 gap-1 mb-1"><div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ë¦¬ìŠ¤í¬</span><div className={ai.risk==='ë†’ìŒ'?'text-red-400':'text-yellow-400'}>{ai.risk}</div></div><div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ëª©í‘œ</span><div className="text-green-400">{fmtN(ai.tg)}</div></div><div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ì†ì ˆ</span><div className="text-red-400">{fmtN(ai.sl)}</div></div></div>
        <div className="text-gray-400 text-[8px]">{ai.rs?.join(' â€¢ ')}</div>
      </div>
    );
  };

  const InvPanel=({code})=>{
    const d=invData[code];if(!d)return null;
    return(
      <div className="grid grid-cols-3 gap-1 text-[9px] mt-1">
        <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ì™¸êµ­ì¸</span><div className={d.fBuy>0?'text-red-400':'text-blue-400'}>{d.fBuy>0?'+':''}{fmtN(d.fBuy)}</div></div>
        <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ê¸°ê´€</span><div className={d.iBuy>0?'text-red-400':'text-blue-400'}>{d.iBuy>0?'+':''}{fmtN(d.iBuy)}</div></div>
        <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ê°œì¸</span><div className={d.pBuy>0?'text-red-400':'text-blue-400'}>{d.pBuy>0?'+':''}{fmtN(d.pBuy)}</div></div>
      </div>
    );
  };

  const Card=({s,i,rank=true,isPort=false})=>(
    <div onClick={()=>{setSel(sel?.code===s.code?null:s);sel?.code!==s.code&&(loadChart(s.code),loadInvestor(s.code))}} className="bg-gray-800 rounded-lg p-2 border border-gray-700 mb-1.5">
      <div className="flex justify-between items-start mb-1">
        <div className="flex items-center gap-1">
          {rank&&<span className="text-xs font-bold text-yellow-500">#{i+1}</span>}
          <div>
            <div className="font-bold text-[11px] flex items-center gap-0.5">{s.name}{s.ps?.is&&<span className="text-orange-400">ğŸ”¥</span>}{s.ptn?.type!=='n'&&<span className="text-cyan-400">ğŸ“Š</span>}<span className="text-[8px] text-gray-500">{s.type}</span></div>
            <div className="text-gray-400 text-[9px]">{s.code}</div>
          </div>
        </div>
        <div className="flex items-center gap-0.5">
          <button onClick={e=>{e.stopPropagation();togCompare(s)}} className={`text-[10px] ${compare.find(c=>c.code===s.code)?'text-cyan-400':'text-gray-500'}`}>âš–ï¸</button>
          <button onClick={e=>togFav(s,e)} className={`text-[10px] ${isFav(s.code)?'text-yellow-400':'text-gray-500'}`}>{isFav(s.code)?'â˜…':'â˜†'}</button>
          <button onClick={e=>{e.stopPropagation();addAlert(s)}} className="text-[10px] text-gray-500">ğŸ””</button>
          <button onClick={e=>{e.stopPropagation();addPort(s)}} className="text-[10px] text-gray-500">ğŸ’¼</button>
          {s.sig&&<SigBadge s={s.sig}/>}
        </div>
      </div>
      
      {isPort&&s.cur?(
        <div className="bg-gray-700/50 rounded p-1.5 mb-1 text-[9px]">
          <div className="grid grid-cols-2 gap-1"><div>ë§¤ìˆ˜:{fmtN(s.buy)}</div><div>í˜„ì¬:{fmtN(s.cur)}</div></div>
          <div className={`text-center font-bold ${s.pnl>=0?'text-red-400':'text-blue-400'}`}>{s.pnl>=0?'+':''}{s.pnl}% ({fmtN(s.amt)})</div>
        </div>
      ):s.price>0&&(
        <>
          <div className="grid grid-cols-2 gap-1 mb-1 text-[9px]">
            <div className="bg-gray-700/50 rounded p-1"><span className="text-gray-400">í˜„ì¬ê°€</span><div className="font-bold">{fmtN(s.price)}</div></div>
            <div className="bg-gray-700/50 rounded p-1"><span className="text-gray-400">ë“±ë½</span><div className={s.chg>=0?'text-red-400 font-bold':'text-blue-400 font-bold'}>{fmtP(s.chg)}</div></div>
          </div>
          <div className="grid grid-cols-6 gap-0.5 mb-1 text-[8px]">
            <div className="bg-gray-700/50 rounded p-0.5 text-center"><span className="text-gray-400">RSI</span><div className={s.rsi>70?'text-red-400':s.rsi<30?'text-blue-400':''}>{s.rsi}</div></div>
            <div className="bg-gray-700/50 rounded p-0.5 text-center"><span className="text-gray-400">ì´í‰</span><div className={s.ma?.st==='ì •ë°°ì—´'?'text-green-400':s.ma?.st==='ì—­ë°°ì—´'?'text-red-400':''}>{s.ma?.st?.slice(0,2)}</div></div>
            <div className="bg-gray-700/50 rounded p-0.5 text-center"><span className="text-gray-400">MACD</span><div className={s.macd?.c==='g'?'text-green-400':'text-red-400'}>{s.macd?.c==='g'?'ê³¨':'ë°'}</div></div>
            <div className="bg-gray-700/50 rounded p-0.5 text-center"><span className="text-gray-400">BB</span><div className={s.bb?.pos==='l'?'text-blue-400':s.bb?.pos==='h'?'text-red-400':''}>{s.bb?.pB}%</div></div>
            <div className="bg-gray-700/50 rounded p-0.5 text-center"><span className="text-gray-400">ADX</span><div>{s.adx?.v}</div></div>
            <div className="bg-gray-700/50 rounded p-0.5 text-center"><span className="text-gray-400">ê±°ë˜</span><div className={s.vol?.s==='í­ì¦'?'text-red-400':''}>{s.vol?.s?.slice(0,1)}</div></div>
          </div>
          <div className="flex gap-0.5 flex-wrap items-center">
            <span className="bg-blue-900/50 text-blue-300 px-1 py-0.5 rounded text-[8px]">{s.strat}</span>
            {s.bbS?.s!=='ê´€ë§'&&<span className="bg-cyan-900/50 text-cyan-300 px-1 py-0.5 rounded text-[8px]">BB:{s.bbS?.s}</span>}
            {s.ichi?.signal?.includes('ë§¤ìˆ˜')&&<span className="bg-yellow-900/50 text-yellow-300 px-1 py-0.5 rounded text-[8px]">â˜ï¸{s.ichi.signal}</span>}
            {s.ptn?.type!=='n'&&<span className={`px-1 py-0.5 rounded text-[8px] ${s.ptn.type==='b'?'bg-green-900/50 text-green-300':'bg-red-900/50 text-red-300'}`}>ğŸ“Š{s.ptn.pattern}</span>}
            <button onClick={e=>{e.stopPropagation();setShowAI(showAI===s.code?null:s.code)}} className="text-purple-400 text-[9px] ml-auto">ğŸ¤–{showAI===s.code?'â–²':'â–¼'}</button>
          </div>
          {showAI===s.code&&<AIPanel s={s}/>}
        </>
      )}
      
      {sel?.code===s.code&&(
        <div className="mt-1.5 pt-1.5 border-t border-gray-700">
          <div className="flex gap-0.5 mb-1 flex-wrap">
            {['w','m','q','h','y'].map(p=><button key={p} onClick={e=>{e.stopPropagation();setPeriod(p)}} className={`px-1 py-0.5 rounded text-[8px] ${period===p?'bg-blue-600':'bg-gray-700'}`}>{p==='w'?'1ì£¼':p==='m'?'1ì›”':p==='q'?'3ì›”':p==='h'?'6ì›”':'1ë…„'}</button>)}
            <button onClick={e=>{e.stopPropagation();setShowBB(!showBB)}} className={`px-1 py-0.5 rounded text-[8px] ${showBB?'bg-cyan-600':'bg-gray-700'}`}>BB</button>
          </div>
          {charts[s.code]?<><PriceChart data={charts[s.code]} period={period} showBB={showBB}/><VolChart data={charts[s.code]} period={period}/></>:<div className="h-24 flex items-center justify-center text-gray-400 text-xs">ë¡œë”©...</div>}
          <InvPanel code={s.code}/>
          {s.sr&&<div className="grid grid-cols-2 gap-1 text-[8px] mt-1"><div className="bg-red-900/30 rounded p-1"><span className="text-gray-400">ì €í•­</span>{s.sr.res?.map((r,i)=><div key={i} className="text-red-400">{fmtN(r)}</div>)}</div><div className="bg-blue-900/30 rounded p-1"><span className="text-gray-400">ì§€ì§€</span>{s.sr.sup?.map((r,i)=><div key={i} className="text-blue-400">{fmtN(r)}</div>)}</div></div>}
          {s.fib&&<div className="bg-gray-700/30 rounded p-1 mt-1 text-[7px]"><span className="text-purple-400">38.2%:{fmtN(Math.round(s.fib.l382))}</span> <span className="text-yellow-400">50%:{fmtN(Math.round(s.fib.l50))}</span> <span className="text-green-400">61.8%:{fmtN(Math.round(s.fib.l618))}</span></div>}
          {s.ichi&&<div className="bg-yellow-900/30 rounded p-1 mt-1 text-[8px]"><span className="text-gray-400">ì¼ëª©:</span> ì „í™˜{fmtN(s.ichi.tenkan)} ê¸°ì¤€{fmtN(s.ichi.kijun)} <span className={s.ichi.signal?.includes('ë§¤ìˆ˜')?'text-green-400':'text-red-400'}>{s.ichi.signal}</span></div>}
          <textarea value={memos[s.code]||''} onChange={e=>saveMemo(s.code,e.target.value)} onClick={e=>e.stopPropagation()} className="w-full bg-gray-700 rounded p-1 text-[9px] h-10 resize-none mt-1" placeholder="ë©”ëª¨..."/>
        </div>
      )}
      <div className="text-center text-[8px] text-gray-500">{sel?.code===s.code?'â–²':'â–¼'}</div>
    </div>
  );

  const PortSum=()=>{
    if(tab!=='port'||!list.length||!list[0].total)return null;
    const inv=list.reduce((s,i)=>s+(i.buy||0)*(i.qty||0),0),val=list.reduce((s,i)=>s+(i.total||0),0),pnl=val-inv;
    return<div className="bg-gradient-to-r from-green-800 to-blue-800 rounded-lg p-2 mb-2"><div className="text-[9px] text-gray-300">í‰ê°€</div><div className="text-base font-bold">{fmtN(val)}ì›</div><div className={pnl>=0?'text-red-300':'text-blue-300'}>{pnl>=0?'+':''}{fmtN(pnl)}ì› ({inv?(pnl/inv*100).toFixed(2):0}%)</div></div>;
  };

  const ComparePanel=()=>{
    if(compare.length<2)return null;
    return(<div className="bg-gray-800 rounded-lg p-2 mb-2 border border-cyan-500/30 text-[9px]"><div className="font-bold mb-1">âš–ï¸ë¹„êµ</div><table className="w-full"><thead><tr className="text-gray-400"><th></th>{compare.map(c=><th key={c.code}>{c.name?.slice(0,4)}</th>)}</tr></thead><tbody><tr><td>ê°€ê²©</td>{compare.map(c=><td key={c.code}>{fmtN(c.price)}</td>)}</tr><tr><td>ë“±ë½</td>{compare.map(c=><td key={c.code} className={c.chg>=0?'text-red-400':'text-blue-400'}>{c.chg?.toFixed(1)}%</td>)}</tr><tr><td>AI</td>{compare.map(c=><td key={c.code} className={c.ai?.sc>0?'text-green-400':'text-red-400'}>{c.ai?.sc}</td>)}</tr></tbody></table><button onClick={()=>setCompare([])} className="text-gray-400 mt-1">ì´ˆê¸°í™”</button></div>);
  };

  const CalcModal=()=>{
    const[ct,setCt]=useState('dca');
    const[v,setV]=useState({b:0,q:0,a:0,aq:0,e:0,t:0,s:0,cap:1e6,rsk:2});
    if(!calcMod)return null;
    return(<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setCalcMod(null)}><div className="bg-gray-800 rounded-xl p-3 w-full max-w-xs text-sm" onClick={e=>e.stopPropagation()}><div className="flex gap-1 mb-2">{['dca','rr','pos'].map(t=><button key={t} onClick={()=>setCt(t)} className={`flex-1 py-1 rounded text-xs ${ct===t?'bg-blue-600':'bg-gray-700'}`}>{t==='dca'?'ë¶„í• ë§¤ìˆ˜':t==='rr'?'ì†ìµë¹„':'í¬ì§€ì…˜'}</button>)}</div>
    {ct==='dca'&&<div className="space-y-2"><input type="number" placeholder="ê¸°ì¡´ë§¤ìˆ˜ê°€" onChange={e=>setV({...v,b:+e.target.value})} className="w-full bg-gray-700 rounded p-2 text-sm"/><input type="number" placeholder="ê¸°ì¡´ìˆ˜ëŸ‰" onChange={e=>setV({...v,q:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/><input type="number" placeholder="ì¶”ê°€ë§¤ìˆ˜ê°€" onChange={e=>setV({...v,a:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/><input type="number" placeholder="ì¶”ê°€ìˆ˜ëŸ‰" onChange={e=>setV({...v,aq:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>{v.b&&v.q&&v.a&&v.aq?<div className="bg-blue-900/50 rounded p-2 text-center">í‰ê· :{fmtN(calcDCA(v.b,v.q,v.a,v.aq).avg)}ì›/{calcDCA(v.b,v.q,v.a,v.aq).tq}ì£¼</div>:null}</div>}
    {ct==='rr'&&<div className="space-y-2"><input type="number" placeholder="ì§„ì…ê°€" onChange={e=>setV({...v,e:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/><input type="number" placeholder="ëª©í‘œê°€" onChange={e=>setV({...v,t:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/><input type="number" placeholder="ì†ì ˆê°€" onChange={e=>setV({...v,s:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>{v.e&&v.t&&v.s?<div className="bg-blue-900/50 rounded p-2 text-center">ì†ìµë¹„:{calcRR(v.e,v.t,v.s)}:1</div>:null}</div>}
    {ct==='pos'&&<div className="space-y-2"><input type="number" value={v.cap} onChange={e=>setV({...v,cap:+e.target.value})} className="w-full bg-gray-700 rounded p-2" placeholder="ìë³¸"/><input type="number" value={v.rsk} onChange={e=>setV({...v,rsk:+e.target.value})} className="w-full bg-gray-700 rounded p-2" placeholder="ë¦¬ìŠ¤í¬%"/><input type="number" onChange={e=>setV({...v,e:+e.target.value})} className="w-full bg-gray-700 rounded p-2" placeholder="ì§„ì…ê°€"/><input type="number" onChange={e=>setV({...v,s:+e.target.value})} className="w-full bg-gray-700 rounded p-2" placeholder="ì†ì ˆê°€"/>{v.e&&v.s?<div className="bg-blue-900/50 rounded p-2 text-center">ë§¤ìˆ˜:{calcPos(v.cap,v.rsk,v.e,v.s)}ì£¼</div>:null}</div>}
    <button onClick={()=>setCalcMod(null)} className="w-full mt-2 py-2 bg-gray-700 rounded">ë‹«ê¸°</button></div></div>);
  };

  if(!logged)return(
    <div className="min-h-screen flex items-center justify-center p-4 bg-gray-900">
      <div className="max-w-sm w-full bg-gray-800 rounded-2xl p-5">
        <h1 className="text-lg font-bold text-center mb-1">ğŸ‡°ğŸ‡· ìŠ¤í¬ë¦¬ë„ˆ Ultimate</h1>
        <p className="text-gray-400 text-xs text-center mb-4">KIS API + AI + íŒ¨í„´ + ì¼ëª©</p>
        <div className="space-y-3">
          <input value={key} onChange={e=>setKey(e.target.value)} className="w-full bg-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="APP KEY"/>
          <input type="password" value={sec} onChange={e=>setSec(e.target.value)} className="w-full bg-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="APP SECRET"/>
          {err&&<div className="text-red-400 text-xs">{err}</div>}
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={save} onChange={e=>setSave(e.target.checked)}/>ğŸ”ì €ì¥</label>
          <button onClick={login} disabled={load} className="w-full bg-blue-600 py-2.5 rounded-lg font-bold disabled:opacity-50">{load?'...':'ğŸ”—ë¡œê·¸ì¸'}</button>
        </div>
      </div>
    </div>
  );

  return(
    <div className="min-h-screen pb-14 bg-gray-900 text-white">
      <div className="max-w-lg mx-auto p-2">
        <div className="bg-gradient-to-r from-blue-700 to-purple-700 rounded-lg p-2 mb-2">
          <div className="flex justify-between items-center">
            <div><h1 className="font-bold text-sm">ğŸ‡°ğŸ‡· Ultimate</h1><div className="flex items-center gap-1">{upd&&<span className="text-[8px] text-gray-300">{upd}</span>}{autoRef&&<span className="text-[8px] text-green-300">ğŸ”„</span>}</div></div>
            <div className="flex gap-1">
              <button onClick={()=>setCalcMod(true)} className="bg-gray-700 px-2 py-1 rounded text-xs">ğŸ§®</button>
              <button onClick={()=>{if(tab==='scan')scan();else if(tab==='fav')refreshFav();else if(tab==='port')refreshPort();else if(tab==='search')searchStock()}} disabled={load} className="bg-white text-purple-800 px-2 py-1 rounded font-bold text-sm disabled:opacity-50">{load?'â³':'ğŸ”'}</button>
            </div>
          </div>
        </div>
        
        {err&&<div className="bg-red-900/50 rounded p-1.5 mb-2 text-red-300 text-xs">{err}</div>}
        
        <div className="flex gap-1 mb-2 overflow-x-auto scroll-hide text-[9px]">
          {[{id:'scan',i:'ğŸ”',l:'ìŠ¤í¬ë¦°'},{id:'fav',i:'â­',l:`ê´€ì‹¬(${favs.length})`},{id:'port',i:'ğŸ’¼',l:'í¬íŠ¸'},{id:'search',i:'ğŸ”',l:'ê²€ìƒ‰'},{id:'alert',i:'ğŸ””',l:'ì•Œë¦¼'},{id:'set',i:'âš™ï¸',l:'ì„¤ì •'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setList([]);setShowAI(null)}} className={`px-1.5 py-1 rounded font-bold whitespace-nowrap ${tab===t.id?'bg-blue-600':'bg-gray-800'}`}>{t.i}{t.l}</button>)}
        </div>
        
        {tab==='scan'&&<>
          <div className="flex gap-0.5 mb-1 flex-wrap">
            {[['day','ğŸ”¥ë°ì´'],['swing','ğŸ“ŠìŠ¤ìœ™'],['bottom','ğŸ”¥ì €ì '],['bb','ğŸ“ŠBB'],['pattern','ğŸ“ŠíŒ¨í„´'],['ichi','â˜ï¸ì¼ëª©']].map(([m,l])=><button key={m} onClick={()=>setMode(m)} className={`px-2 py-1 rounded font-bold text-[9px] ${mode===m?'bg-blue-600':'bg-gray-800'}`}>{l}</button>)}
          </div>
          <div className="flex gap-1 mb-2">
            {[['all','ì „ì²´'],['low','ğŸª™ë™ì „'],['mid','ğŸ’µì¤‘ê°€']].map(([p,l])=><button key={p} onClick={()=>setPrice(p)} className={`flex-1 py-1 rounded font-bold text-[9px] ${price===p?'bg-green-600':'bg-gray-800'}`}>{l}</button>)}
          </div>
        </>}
        
        {tab==='search'&&<div className="mb-2"><input value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==='Enter'&&searchStock()} className="w-full bg-gray-800 rounded px-3 py-2 text-sm" placeholder="ì¢…ëª©ì½”ë“œ 6ìë¦¬"/></div>}
        
        {tab==='alert'&&<div className="space-y-1.5 text-[10px]">
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded"><span>ğŸ””ì•Œë¦¼</span><button onClick={()=>setAlertOn(!alertOn)} className={`w-10 h-5 rounded-full ${alertOn?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full transform ${alertOn?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {alerts.map((a,i)=><div key={i} className="p-1.5 bg-gray-800 rounded flex justify-between"><div><b>{a.name}</b> {a.type} {fmtN(a.val)}</div><div className="flex gap-1"><button onClick={()=>togAlert(i)} className={`w-8 h-4 rounded-full ${a.on?'bg-green-500':'bg-gray-600'}`}><div className={`w-3 h-3 bg-white rounded-full ${a.on?'translate-x-4':'translate-x-0.5'}`}/></button><button onClick={()=>delAlert(i)} className="text-red-400">ğŸ—‘</button></div></div>)}
        </div>}
        
        {tab==='set'&&<div className="space-y-1.5 text-[10px]">
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded"><span>ğŸ”„ìë™ìƒˆë¡œê³ ì¹¨</span><button onClick={()=>setAutoRef(!autoRef)} className={`w-10 h-5 rounded-full ${autoRef?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full ${autoRef?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {autoRef&&<div className="flex gap-1">{[30,60,120].map(s=><button key={s} onClick={()=>setRefInt(s)} className={`flex-1 py-1 rounded ${refInt===s?'bg-blue-600':'bg-gray-700'}`}>{s}ì´ˆ</button>)}</div>}
          <div className="p-2 bg-gray-800 rounded">
            <div className="mb-1">ë°ì´í„°: ê´€ì‹¬{favs.length} í¬íŠ¸{port.length} ì•Œë¦¼{alerts.length}</div>
            <div className="flex gap-1">
              <button onClick={()=>exportCSV(favs,'favs.csv')} className="flex-1 py-1 bg-blue-700 rounded">ğŸ“¤CSV</button>
              <button onClick={backup} className="flex-1 py-1 bg-green-700 rounded">ğŸ’¾ë°±ì—…</button>
              <label className="flex-1 py-1 bg-green-700 rounded text-center cursor-pointer">ğŸ“‚ë³µì›<input type="file" accept=".json" onChange={restore} className="hidden"/></label>
            </div>
            <button onClick={()=>confirm('ì‚­ì œ?')&&(setFavs([]),setPort([]),setAlerts([]),setMemos({}),localStorage.clear())} className="w-full mt-1 py-1 bg-red-600 rounded">ğŸ—‘ì „ì²´ì‚­ì œ</button>
          </div>
          <button onClick={logout} className="w-full py-2 bg-gray-700 rounded">ğŸšªë¡œê·¸ì•„ì›ƒ</button>
        </div>}
        
        <ComparePanel/>
        <PortSum/>
        
        {list.length>0&&!load&&!['alert','set'].includes(tab)&&<div>{list.map((s,i)=><Card key={s.code} s={s} i={i} rank={tab==='scan'} isPort={tab==='port'}/>)}</div>}
        
        {!list.length&&!load&&!['alert','set'].includes(tab)&&<div className="text-center py-8"><div className="text-2xl mb-2">{tab==='scan'?'ğŸ“ˆ':'ğŸ”'}</div><p className="text-gray-400 text-sm">ğŸ”ì‹œì‘</p></div>}
        
        {load&&<div className="text-center py-8"><div className="text-2xl animate-bounce">ğŸ”</div><p className="text-gray-400 text-xs mt-2">{prog}</p></div>}
      </div>
      
      {modal==='port'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-3 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-2 text-sm">ğŸ’¼í¬íŠ¸</h3><div className="text-xs mb-2">{form.name}</div><input type="number" value={form.buy} onChange={e=>setForm({...form,buy:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ë§¤ìˆ˜ê°€"/><input type="number" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ìˆ˜ëŸ‰"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded">ì·¨ì†Œ</button><button onClick={savePort} className="flex-1 py-2 bg-blue-600 rounded font-bold">ì €ì¥</button></div></div></div>}
      
      {modal==='alert'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-3 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-2 text-sm">ğŸ””ì•Œë¦¼</h3><div className="text-xs mb-2">{form.name}</div><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm"><option value="target">ëª©í‘œê°€</option><option value="stop">ì†ì ˆê°€</option><option value="surge">ê¸‰ë“±%</option></select><input type="number" value={form.val} onChange={e=>setForm({...form,val:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ê°’"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded">ì·¨ì†Œ</button><button onClick={saveAlert} className="flex-1 py-2 bg-blue-600 rounded font-bold">ì €ì¥</button></div></div></div>}
      
      <CalcModal/>
    </div>
  );
};

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
