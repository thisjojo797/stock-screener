<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ Pro Max</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    *{-webkit-tap-highlight-color:transparent}body{margin:0;padding:0;overscroll-behavior:none}
    body.light{background:#f3f4f6;color:#1f2937}
    body.light .dark-bg{background:#fff!important}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .animate-pulse-slow{animation:pulse 2s infinite}
    .scrollbar-hide::-webkit-scrollbar{display:none}
  </style>
</head>
<body class="bg-gray-900 text-white">
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef}=React;
const API=window.location.origin+'/api';

// ========== ê¸°ìˆ ì  ì§€í‘œ ==========
const calcRSI=(p,n=14)=>{if(p.length<n+1)return 50;let g=0,l=0;for(let i=1;i<=n;i++){const c=p[i-1]-p[i];c>0?g+=c:l-=c}return l===0?100:Math.round(100-(100/(1+(g/n)/(l/n))))};
const calcMACD=(p)=>{if(p.length<26)return{cross:'none',hist:0};const ema=(d,n)=>{let e=d.slice(0,n).reduce((a,b)=>a+b)/n;for(let i=n;i<d.length;i++)e=d[i]*(2/(n+1))+e*(1-2/(n+1));return e};const m=ema(p,12)-ema(p,26),s=m*0.8;return{cross:m>s?'golden':'dead',hist:m-s,val:m.toFixed(0)}};
const calcBB=(p,n=20)=>{if(p.length<n)return{pos:'mid',width:0,pctB:50};const s=p.slice(0,n),avg=s.reduce((a,b)=>a+b)/n,std=Math.sqrt(s.reduce((x,v)=>x+Math.pow(v-avg,2),0)/n);const u=avg+std*2,l=avg-std*2,width=((u-l)/avg*100).toFixed(1),pctB=std===0?50:((p[0]-l)/(u-l)*100).toFixed(0);let pos='mid';if(p[0]>=u)pos='high';else if(p[0]<=l)pos='low';else if(p[0]>avg+std)pos='upper';else if(p[0]<avg-std)pos='lower';return{pos,u,l,avg,width,pctB:+pctB,std}};
const calcStoch=(data,k=14)=>{if(data.length<k)return{k:50,d:50,sig:'ì¤‘ë¦½'};const highs=data.slice(0,k).map(x=>x.h),lows=data.slice(0,k).map(x=>x.l);const hh=Math.max(...highs),ll=Math.min(...lows);const kVal=hh===ll?50:((data[0].c-ll)/(hh-ll))*100;let sig='ì¤‘ë¦½';if(kVal>80)sig='ê³¼ë§¤ìˆ˜';else if(kVal<20)sig='ê³¼ë§¤ë„';else if(kVal>50)sig='ìƒìŠ¹';else sig='í•˜ë½';return{k:Math.round(kVal),sig}};
const calcOBV=(data)=>{if(data.length<10)return{trend:'ë¶€ì¡±'};let obv=0;for(let i=data.length-1;i>0;i--){if(data[i-1].c>data[i].c)obv+=data[i-1].v;else if(data[i-1].c<data[i].c)obv-=data[i-1].v}const r=data.slice(0,5);let t5=0;for(let i=1;i<r.length;i++){if(r[i-1].c>r[i].c)t5+=r[i-1].v;else if(r[i-1].c<r[i].c)t5-=r[i-1].v}let trend='íš¡ë³´';if(t5>0&&data[0].c>data[4]?.c)trend='ìƒìŠ¹í™•ì¸';else if(t5<0&&data[0].c<data[4]?.c)trend='í•˜ë½í™•ì¸';else if(t5>0&&data[0].c<data[4]?.c)trend='ìƒìŠ¹ë‹¤ì´ë²„';else if(t5<0&&data[0].c>data[4]?.c)trend='í•˜ë½ë‹¤ì´ë²„';return{trend}};
const calcWilliams=(data,n=14)=>{if(data.length<n)return{val:-50,sig:'ì¤‘ë¦½'};const hh=Math.max(...data.slice(0,n).map(x=>x.h)),ll=Math.min(...data.slice(0,n).map(x=>x.l));const wr=hh===ll?-50:((hh-data[0].c)/(hh-ll))*-100;return{val:Math.round(wr),sig:wr>-20?'ê³¼ë§¤ìˆ˜':wr<-80?'ê³¼ë§¤ë„':'ì¤‘ë¦½'}};
const calcCCI=(data,n=20)=>{if(data.length<n)return{val:0,sig:'ì¤‘ë¦½'};const tp=data.slice(0,n).map(x=>(x.h+x.l+x.c)/3),sma=tp.reduce((a,b)=>a+b)/n,md=tp.reduce((s,v)=>s+Math.abs(v-sma),0)/n;const cci=md===0?0:(tp[0]-sma)/(0.015*md);return{val:Math.round(cci),sig:cci>100?'ê³¼ë§¤ìˆ˜':cci<-100?'ê³¼ë§¤ë„':cci>0?'ê°•ì„¸':'ì•½ì„¸'}};
const calcVol=(v)=>{if(v.length<20)return{r:1,s:'ë³´í†µ'};const avg=v.slice(0,20).reduce((a,b)=>a+b)/20,r=v[0]/avg;return{r:r.toFixed(1),s:r>=3?'í­ì¦':r>=2?'ê¸‰ì¦':r>=1.5?'ì¦ê°€':'ë³´í†µ'}};
const detectCandle=(c)=>{if(c.length<2)return{p:'ì—†ìŒ',sig:'n'};const[t,y]=c,b=t.c-t.o,rng=t.h-t.l,ls=Math.min(t.o,t.c)-t.l;if(ls>Math.abs(b)*2)return{p:'ë§ì¹˜í˜•',sig:'b'};if(Math.abs(b)<rng*0.1)return{p:'ë„ì§€',sig:'n'};if(b>0&&(y.c-y.o)<0&&Math.abs(b)>Math.abs(y.c-y.o))return{p:'ìƒìŠ¹ì¥ì•…',sig:'b'};if(b<0&&(y.c-y.o)>0&&Math.abs(b)>Math.abs(y.c-y.o))return{p:'í•˜ë½ì¥ì•…',sig:'s'};return{p:'ì—†ìŒ',sig:'n'}};
const getMA=(p)=>{if(p.length<60)return{status:'ë¶€ì¡±'};const m5=p.slice(0,5).reduce((a,b)=>a+b)/5,m20=p.slice(0,20).reduce((a,b)=>a+b)/20,m60=p.slice(0,60).reduce((a,b)=>a+b)/60;let status='í˜¼ì¡°';if(m5>m20&&m20>m60)status='ì •ë°°ì—´';else if(m5<m20&&m20<m60)status='ì—­ë°°ì—´';else if(p[0]>m60)status='60ì¼â†‘';else if(p[0]>m20)status='20ì¼â†‘';return{status,m5,m20,m60,cross5_20:m5>m20?'ìœ„':'ì•„ë˜'}};

// ë³¼ë¦°ì €ë°´ë“œ ë§¤ë§¤ê¸°ë²•
const getBBStrategy=(bb,price,prevBB)=>{
  if(!bb||bb.pos==='mid')return{sig:'ê´€ë§',desc:'ë°´ë“œ ì¤‘ì•™'};
  let sig='ê´€ë§',desc='';
  // í•˜ë‹¨ í„°ì¹˜ í›„ ë°˜ë“±
  if(bb.pctB<=5)return{sig:'ë§¤ìˆ˜ëŒ€ê¸°',desc:'í•˜ë‹¨í„°ì¹˜-ë°˜ë“±ëŒ€ê¸°'};
  if(bb.pctB<=20&&bb.pctB>5)return{sig:'ë§¤ìˆ˜',desc:'í•˜ë‹¨ë°˜ë“±'};
  // ìƒë‹¨ í„°ì¹˜
  if(bb.pctB>=95)return{sig:'ë§¤ë„ëŒ€ê¸°',desc:'ìƒë‹¨í„°ì¹˜-ì¡°ì •ëŒ€ê¸°'};
  if(bb.pctB>=80)return{sig:'ìµì ˆê³ ë ¤',desc:'ìƒë‹¨ì ‘ê·¼'};
  // ë°´ë“œ ìˆ˜ì¶• í›„ í™•ì¥ (ìŠ¤í€´ì¦ˆ)
  if(bb.width<10)return{sig:'ëŒíŒŒëŒ€ê¸°',desc:'ìŠ¤í€´ì¦ˆ-ë³€ë™ì„±í™•ëŒ€ì˜ˆìƒ'};
  // ë°´ë“œì›Œí‚¹
  if(bb.pctB>=70&&bb.pctB<95)return{sig:'ì¶”ì„¸ì¶”ì¢…',desc:'ìƒë‹¨ë°´ë“œì›Œí‚¹'};
  if(bb.pctB<=30&&bb.pctB>5)return{sig:'í•˜ë½ì¶”ì„¸',desc:'í•˜ë‹¨ë°´ë“œì›Œí‚¹'};
  return{sig:'ê´€ë§',desc:'ì¤‘ë¦½êµ¬ê°„'};
};

// ê¸‰ë“±í›„ì €ì  ë¶„ì„
const analyzePostSurge=(data)=>{
  if(data.length<60)return{isPostSurge:false,score:0};
  const prices=data.map(x=>x.c),cur=prices[0];
  const h3m=Math.max(...prices.slice(0,60)),h6m=Math.max(...prices.slice(0,Math.min(120,prices.length)));
  const l3m=Math.min(...prices.slice(0,60)),l20=Math.min(...prices.slice(0,20));
  const drop3m=((h3m-cur)/h3m*100).toFixed(1),drop6m=((h6m-cur)/h6m*100).toFixed(1);
  const fromLow=((cur-l3m)/l3m*100).toFixed(1);
  let score=0,details=[];
  if(drop6m>30){score+=30;details.push(`6ê°œì›”ê³ ì -${drop6m}%`)}
  if(drop3m>20){score+=20;details.push(`3ê°œì›”ê³ ì -${drop3m}%`)}
  if(((cur-l3m)/l3m*100)<10){score+=25;details.push('3ê°œì›”ì €ì ê·¼ì²˜')}
  if(((cur-l20)/l20*100)<5){score+=15;details.push('ìµœê·¼ì €ì ê·¼ì²˜')}
  const vols=data.map(x=>x.v),avgV=vols.slice(0,60).reduce((a,b)=>a+b)/60;
  if(vols.slice(0,5).reduce((a,b)=>a+b)/5<avgV*0.7){score+=10;details.push('ê±°ë˜ëŸ‰ë°”ë‹¥')}
  return{isPostSurge:score>=50,score,details,h3m,h6m,l3m,drop3m:+drop3m,drop6m:+drop6m,fromLow:+fromLow,target:Math.round(cur*1.3),recovery:Math.round(h3m*0.7)};
};

// ì§€ì§€/ì €í•­ì„  ê³„ì‚°
const calcSupportResistance=(data)=>{
  if(data.length<20)return{support:[],resistance:[]};
  const prices=data.slice(0,60);
  const highs=prices.map(x=>x.h).sort((a,b)=>b-a);
  const lows=prices.map(x=>x.l).sort((a,b)=>a-b);
  return{
    resistance:[highs[0],highs[Math.floor(highs.length*0.1)],highs[Math.floor(highs.length*0.2)]],
    support:[lows[0],lows[Math.floor(lows.length*0.1)],lows[Math.floor(lows.length*0.2)]]
  };
};

// í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼
const calcFibonacci=(data)=>{
  if(data.length<20)return null;
  const prices=data.slice(0,60);
  const high=Math.max(...prices.map(x=>x.h)),low=Math.min(...prices.map(x=>x.l));
  const diff=high-low;
  return{
    l100:low,l786:low+diff*0.236,l618:low+diff*0.382,l50:low+diff*0.5,l382:low+diff*0.618,l236:low+diff*0.786,l0:high
  };
};

// AI ì¢…í•© ì ìˆ˜
const calcAIScore=(s)=>{
  let score=0,reasons=[];
  const{rsi,ma,macd,bb,stoch,cci,obv,vol,cnd,postSurge,bbStrat}=s;
  
  if(rsi<30){score+=15;reasons.push('RSIê³¼ë§¤ë„')}else if(rsi<40){score+=8;reasons.push('RSIë§¤ìˆ˜ì ì •')}else if(rsi>70){score-=15;reasons.push('RSIê³¼ë§¤ìˆ˜')}
  if(ma?.status==='ì •ë°°ì—´'){score+=20;reasons.push('ì •ë°°ì—´')}else if(ma?.status==='ì—­ë°°ì—´'){score-=20;reasons.push('ì—­ë°°ì—´')}else if(ma?.status==='60ì¼â†‘'){score+=10;reasons.push('60ì¼ì§€ì§€')}
  if(macd?.cross==='golden'){score+=15;reasons.push('MACDê³¨ë“ ')}else if(macd?.cross==='dead'){score-=15;reasons.push('MACDë°ë“œ')}
  if(bb?.pos==='low'){score+=12;reasons.push('ë³¼ë¦°ì €í•˜ë‹¨')}else if(bb?.pos==='high'){score-=12;reasons.push('ë³¼ë¦°ì €ìƒë‹¨')}
  if(bbStrat?.sig==='ë§¤ìˆ˜'){score+=10;reasons.push('BBë§¤ìˆ˜ì‹ í˜¸')}else if(bbStrat?.sig==='ë§¤ë„ëŒ€ê¸°'){score-=10;reasons.push('BBë§¤ë„ì‹ í˜¸')}
  if(stoch?.sig==='ê³¼ë§¤ë„'){score+=10;reasons.push('ìŠ¤í† ìºê³¼ë§¤ë„')}else if(stoch?.sig==='ê³¼ë§¤ìˆ˜'){score-=10;reasons.push('ìŠ¤í† ìºê³¼ë§¤ìˆ˜')}
  if(obv?.trend?.includes('ìƒìŠ¹')){score+=12;reasons.push('OBV'+obv.trend)}else if(obv?.trend?.includes('í•˜ë½')){score-=12;reasons.push('OBV'+obv.trend)}
  if(vol?.s==='í­ì¦'){score+=8;reasons.push('ê±°ë˜ëŸ‰í­ì¦')}else if(vol?.s==='ê¸‰ì¦'){score+=5;reasons.push('ê±°ë˜ëŸ‰ê¸‰ì¦')}
  if(cnd?.sig==='b'){score+=8;reasons.push('ìƒìŠ¹ìº”ë“¤')}else if(cnd?.sig==='s'){score-=8;reasons.push('í•˜ë½ìº”ë“¤')}
  if(postSurge?.isPostSurge){score+=25;reasons.unshift('ğŸ”¥ê¸‰ë“±í›„ì €ì ')}
  if(cci?.sig==='ê³¼ë§¤ë„'){score+=5;reasons.push('CCIê³¼ë§¤ë„')}else if(cci?.sig==='ê³¼ë§¤ìˆ˜'){score-=5;reasons.push('CCIê³¼ë§¤ìˆ˜')}
  
  let action='âšªê´€ë§',confidence=50,risk='ì¤‘ê°„';
  if(score>=40){action='ğŸŸ¢ì ê·¹ë§¤ìˆ˜';confidence=Math.min(95,60+score)}
  else if(score>=20){action='ğŸ”µë§¤ìˆ˜ê³ ë ¤';confidence=Math.min(85,50+score)}
  else if(score<=-40){action='ğŸ”´ì ê·¹ë§¤ë„';confidence=Math.min(95,60-score)}
  else if(score<=-20){action='ğŸŸ ë§¤ë„ê³ ë ¤';confidence=Math.min(85,50-score)}
  
  if(vol?.s==='í­ì¦'||Math.abs(s.chg||0)>10)risk='ë†’ìŒ';
  else if(ma?.status==='ì •ë°°ì—´'&&rsi>40&&rsi<60)risk='ë‚®ìŒ';
  
  const price=s.price||0;
  let target=Math.round(price*(score>0?1.1:0.95));
  let stopLoss=Math.round(price*(score>0?0.95:1.05));
  if(postSurge?.isPostSurge){target=postSurge.recovery;stopLoss=Math.round(price*0.93)}
  
  return{score,action,confidence,risk,target,stopLoss,reasons:reasons.slice(0,7)};
};

// ë§¤ë§¤ ì „ëµ íŒë‹¨
const getStrategy=(s)=>{
  const{rsi,ma,macd,bb,stoch,obv,vol,cnd,postSurge,bbStrat,chg}=s;
  if(postSurge?.score>=70)return'ğŸ”¥ê¸‰ë“±í›„ì €ì ë§¤ìˆ˜';
  if(postSurge?.isPostSurge)return'ğŸ“‰ëˆŒë¦¼ëª©ë°˜ë“±';
  if(bbStrat?.sig==='ë§¤ìˆ˜')return'ğŸ“ŠBBí•˜ë‹¨ë°˜ë“±';
  if(bbStrat?.sig==='ëŒíŒŒëŒ€ê¸°')return'âš¡BBìŠ¤í€´ì¦ˆ';
  if(chg>10&&vol?.s==='í­ì¦')return'ğŸ”¥ë‰´ìŠ¤ë§¤ë§¤';
  if(macd?.cross==='golden'&&stoch?.sig==='ìƒìŠ¹')return'ğŸš€MACD+ìŠ¤í† ìº';
  if(macd?.cross==='golden')return'ğŸ“ˆMACDê³¨ë“ ';
  if(obv?.trend==='ìƒìŠ¹ë‹¤ì´ë²„')return'ğŸ’OBVë‹¤ì´ë²„';
  if(cnd?.sig==='b')return'ğŸ•¯ï¸'+cnd.p;
  if(ma?.status==='ì •ë°°ì—´'&&rsi>50&&rsi<70)return'ğŸ“Šì¶”ì„¸ë§¤ë§¤';
  if(stoch?.sig==='ê³¼ë§¤ë„'&&rsi<35)return'ğŸ”„ê³¼ë§¤ë„ë°˜ë“±';
  if(ma?.status?.includes('â†‘'))return'ğŸ“‰ëˆŒë¦¼ëª©';
  if(rsi<30)return'ğŸ’¡ì—­ë°œìƒ';
  return'ğŸ‘€ê´€ë§';
};

// ì‹ í˜¸ íŒë‹¨
const getSignal=(s)=>{
  const ai=s.ai||calcAIScore(s);
  if(ai.score>=40)return'ê°•ë ¥ë§¤ìˆ˜';
  if(ai.score>=20)return'ë§¤ìˆ˜';
  if(ai.score<=-40)return'ê°•ë ¥ë§¤ë„';
  if(ai.score<=-20)return'ë§¤ë„';
  return'ê´€ë§';
};

// ë¶„í• ë§¤ìˆ˜ ê³„ì‚°ê¸°
const calcDCA=(buyPrice,buyQty,addPrice,addQty)=>{
  const totalQty=buyQty+addQty;
  const avgPrice=(buyPrice*buyQty+addPrice*addQty)/totalQty;
  return{avgPrice:Math.round(avgPrice),totalQty};
};

// ì†ìµë¹„ ê³„ì‚°ê¸°
const calcRiskReward=(entry,target,stopLoss)=>{
  const reward=Math.abs(target-entry);
  const risk=Math.abs(entry-stopLoss);
  return risk===0?0:(reward/risk).toFixed(2);
};

// í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ ê³„ì‚°
const calcPositionSize=(capital,riskPct,entry,stopLoss)=>{
  const riskAmt=capital*(riskPct/100);
  const riskPerShare=Math.abs(entry-stopLoss);
  return riskPerShare===0?0:Math.floor(riskAmt/riskPerShare);
};

const fmtVol=(v)=>v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v;
const fmtNum=(n)=>n?.toLocaleString()||'0';

// ========== ì°¨íŠ¸ ì»´í¬ë„ŒíŠ¸ ==========
const PriceChart=({data,name,period,showBB,showFib})=>{
  const ref=useRef(),chart=useRef();
  useEffect(()=>{
    if(!ref.current||!data?.length)return;
    chart.current?.destroy();
    const days={w:7,m:30,q:60,h:120,y:250}[period]||60;
    const d=data.slice(0,days),labels=d.map(x=>x.dt).reverse(),prices=d.map(x=>x.c).reverse();
    const ma5=[],ma20=[],ma60=[],bbU=[],bbL=[],bbM=[];
    for(let i=0;i<prices.length;i++){
      ma5.push(i>=4?prices.slice(i-4,i+1).reduce((a,b)=>a+b)/5:null);
      ma20.push(i>=19?prices.slice(i-19,i+1).reduce((a,b)=>a+b)/20:null);
      ma60.push(i>=59?prices.slice(i-59,i+1).reduce((a,b)=>a+b)/60:null);
      if(showBB&&i>=19){
        const s=prices.slice(i-19,i+1),avg=s.reduce((a,b)=>a+b)/20,std=Math.sqrt(s.reduce((x,v)=>x+Math.pow(v-avg,2),0)/20);
        bbU.push(avg+std*2);bbL.push(avg-std*2);bbM.push(avg);
      }else{bbU.push(null);bbL.push(null);bbM.push(null)}
    }
    const datasets=[
      {label:'ì¢…ê°€',data:prices,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.1,pointRadius:0,borderWidth:2},
      {label:'MA5',data:ma5,borderColor:'#f59e0b',borderWidth:1,pointRadius:0,borderDash:[2,2]},
      {label:'MA20',data:ma20,borderColor:'#ef4444',borderWidth:1,pointRadius:0,borderDash:[2,2]},
      {label:'MA60',data:ma60,borderColor:'#8b5cf6',borderWidth:1,pointRadius:0,borderDash:[2,2]}
    ];
    if(showBB){
      datasets.push({label:'BBìƒë‹¨',data:bbU,borderColor:'#6b7280',borderWidth:1,pointRadius:0,fill:false});
      datasets.push({label:'BBí•˜ë‹¨',data:bbL,borderColor:'#6b7280',borderWidth:1,pointRadius:0,fill:'-1',backgroundColor:'rgba(107,114,128,0.1)'});
    }
    chart.current=new window.Chart(ref.current,{type:'line',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{color:'#9ca3af',font:{size:7},boxWidth:6}}},scales:{x:{ticks:{color:'#6b7280',maxTicksLimit:5,font:{size:6}},grid:{color:'#374151'}},y:{ticks:{color:'#6b7280',font:{size:6}},grid:{color:'#374151'}}}}});
    return()=>chart.current?.destroy();
  },[data,period,showBB,showFib]);
  return <div className="h-36"><canvas ref={ref}/></div>;
};

const VolChart=({data,period})=>{
  const ref=useRef(),chart=useRef();
  useEffect(()=>{
    if(!ref.current||!data?.length)return;
    chart.current?.destroy();
    const days={w:7,m:30,q:60,h:120,y:250}[period]||60;
    const d=data.slice(0,days),labels=d.map(x=>x.dt).reverse(),vols=d.map(x=>x.v/1e6).reverse();
    const colors=d.map(x=>x.c>=x.o?'rgba(239,68,68,0.7)':'rgba(59,130,246,0.7)').reverse();
    chart.current=new window.Chart(ref.current,{type:'bar',data:{labels,datasets:[{data:vols,backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{ticks:{color:'#6b7280',font:{size:5}},grid:{color:'#374151'}}}}});
    return()=>chart.current?.destroy();
  },[data,period]);
  return <div className="h-12"><canvas ref={ref}/></div>;
};

// ========== ë©”ì¸ ì•± ==========
const App=()=>{
  const[key,setKey]=useState(localStorage.getItem('k')||'');
  const[sec,setSec]=useState(localStorage.getItem('s')||'');
  const[save,setSave]=useState(localStorage.getItem('sv')==='1');
  const[logged,setLogged]=useState(false);
  const[tab,setTab]=useState('scan');
  const[mode,setMode]=useState('day');
  const[price,setPrice]=useState('all');
  const[load,setLoad]=useState(false);
  const[err,setErr]=useState('');
  const[list,setList]=useState([]);
  const[sel,setSel]=useState(null);
  const[upd,setUpd]=useState('');
  const[prog,setProg]=useState('');
  const[period,setPeriod]=useState('q');
  const[showBB,setShowBB]=useState(true);
  const[favs,setFavs]=useState(()=>JSON.parse(localStorage.getItem('fav')||'[]'));
  const[port,setPort]=useState(()=>JSON.parse(localStorage.getItem('port')||'[]'));
  const[alerts,setAlerts]=useState(()=>JSON.parse(localStorage.getItem('alrt')||'[]'));
  const[alertOn,setAlertOn]=useState(localStorage.getItem('alrtOn')!=='0');
  const[dark,setDark]=useState(localStorage.getItem('dk')!=='0');
  const[charts,setCharts]=useState({});
  const[modal,setModal]=useState(null);
  const[form,setForm]=useState({});
  const[search,setSearch]=useState('');
  const[memos,setMemos]=useState(()=>JSON.parse(localStorage.getItem('memos')||'{}'));
  const[autoRefresh,setAutoRefresh]=useState(localStorage.getItem('autoRef')==='1');
  const[refreshInterval,setRefreshInterval]=useState(+(localStorage.getItem('refInt')||'60'));
  const[showAI,setShowAI]=useState(null);
  const[trades,setTrades]=useState(()=>JSON.parse(localStorage.getItem('trades')||'[]'));
  const[compare,setCompare]=useState([]);
  const[calcModal,setCalcModal]=useState(null);

  useEffect(()=>{localStorage.setItem('fav',JSON.stringify(favs))},[favs]);
  useEffect(()=>{localStorage.setItem('port',JSON.stringify(port))},[port]);
  useEffect(()=>{localStorage.setItem('alrt',JSON.stringify(alerts))},[alerts]);
  useEffect(()=>{localStorage.setItem('alrtOn',alertOn?'1':'0')},[alertOn]);
  useEffect(()=>{localStorage.setItem('dk',dark?'1':'0');document.body.className=dark?'bg-gray-900 text-white':'light bg-gray-100 text-gray-900'},[dark]);
  useEffect(()=>{localStorage.setItem('memos',JSON.stringify(memos))},[memos]);
  useEffect(()=>{localStorage.setItem('autoRef',autoRefresh?'1':'0')},[autoRefresh]);
  useEffect(()=>{localStorage.setItem('refInt',refreshInterval)},[refreshInterval]);
  useEffect(()=>{localStorage.setItem('trades',JSON.stringify(trades))},[trades]);
  useEffect(()=>{if(save&&key&&sec)login()},[]);

  useEffect(()=>{
    if(!autoRefresh||!logged)return;
    const iv=setInterval(()=>{if(tab==='scan')scan();else if(tab==='fav')refreshFav();else if(tab==='port')refreshPort()},refreshInterval*1000);
    return()=>clearInterval(iv);
  },[autoRefresh,refreshInterval,logged,tab]);

  const login=async()=>{
    if(!key||!sec){setErr('KEY/SECRET í•„ìš”');return}
    setLoad(true);setErr('');
    try{
      const r=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec})});
      if(r.ok){if(save){localStorage.setItem('k',key);localStorage.setItem('s',sec);localStorage.setItem('sv','1')}setLogged(true);Notification.permission==='default'&&Notification.requestPermission()}
      else setErr((await r.json()).error||'ì‹¤íŒ¨');
    }catch(e){setErr(e.message)}
    setLoad(false);
  };

  const logout=()=>{setLogged(false);setList([]);['k','s','sv'].forEach(x=>localStorage.removeItem(x));setKey('');setSec('')};

  const loadChart=async(code)=>{
    if(charts[code])return charts[code];
    try{
      const r=await fetch(API+'/daily-chart',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:code})});
      const d=await r.json();
      if(d.success&&d.data){
        const f=d.data.map(x=>({dt:x.stck_bsop_date.slice(4,6)+'/'+x.stck_bsop_date.slice(6,8),o:+x.stck_oprc,h:+x.stck_hgpr,l:+x.stck_lwpr,c:+x.stck_clpr,v:+x.acml_vol})).filter(x=>x.c>0);
        setCharts(p=>({...p,[code]:f}));return f;
      }
    }catch{}return[];
  };

  const analyze=async(code,name,rawData)=>{
    const ch=rawData||await loadChart(code);
    if(!ch.length)return{error:true};
    const prices=ch.map(x=>x.c),vols=ch.map(x=>x.v);
    const rsi=calcRSI(prices),ma=getMA(prices),macd=calcMACD(prices),bb=calcBB(prices);
    const stoch=calcStoch(ch),obv=calcOBV(ch),williams=calcWilliams(ch),cci=calcCCI(ch);
    const vol=calcVol(vols),cnd=detectCandle(ch.slice(0,3)),postSurge=analyzePostSurge(ch);
    const bbStrat=getBBStrategy(bb,prices[0]);
    const sr=calcSupportResistance(ch),fib=calcFibonacci(ch);
    const result={rsi,ma,macd,bb,stoch,obv,williams,cci,vol,cnd,postSurge,bbStrat,sr,fib};
    result.ai=calcAIScore(result);
    result.strat=getStrategy(result);
    result.sig=getSignal(result);
    return result;
  };

  const scan=async()=>{
    setLoad(true);setErr('');setProg('ì¡°íšŒì¤‘...');
    try{
      const results={low:[],mid:[]};
      // ë™ì „ì£¼
      setProg('ë™ì „ì£¼ ì¡°íšŒì¤‘...');
      const[vLow,cLow]=await Promise.all([
        fetch(API+'/volume-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'10',priceMax:'999'})}).then(r=>r.json()),
        fetch(API+'/change-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'10',priceMax:'999',isUp:true})}).then(r=>r.json())
      ]);
      const mapLow=new Map();
      [...(vLow.data||[]),...(cLow.data||[])].forEach(s=>{const c=s.mksc_shrn_iscd||s.stck_shrn_iscd;if(c&&!mapLow.has(c))mapLow.set(c,s)});
      const topLow=Array.from(mapLow.values()).slice(0,15);
      
      for(let i=0;i<topLow.length;i++){
        const s=topLow[i],code=s.mksc_shrn_iscd||s.stck_shrn_iscd;
        setProg(`ë™ì „ì£¼(${i+1}/${topLow.length}) ${s.hts_kor_isnm}`);
        await new Promise(r=>setTimeout(r,150));
        const ch=await loadChart(code),a=await analyze(code,s.hts_kor_isnm,ch);
        if(!a.error)results.low.push({code,name:s.hts_kor_isnm,price:+s.stck_prpr||0,chg:+s.prdy_ctrt||0,volume:+s.acml_vol||0,h52:+s.w52_hgpr||0,l52:+s.w52_lwpr||0,type:'ë™ì „ì£¼',...a});
      }
      
      // ì¤‘ê°€ì£¼
      setProg('ì¤‘ê°€ì£¼ ì¡°íšŒì¤‘...');
      const[vMid,cMid]=await Promise.all([
        fetch(API+'/volume-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'1000',priceMax:'9999'})}).then(r=>r.json()),
        fetch(API+'/change-rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,priceMin:'1000',priceMax:'9999',isUp:true})}).then(r=>r.json())
      ]);
      const mapMid=new Map();
      [...(vMid.data||[]),...(cMid.data||[])].forEach(s=>{const c=s.mksc_shrn_iscd||s.stck_shrn_iscd;if(c&&!mapMid.has(c))mapMid.set(c,s)});
      const topMid=Array.from(mapMid.values()).slice(0,15);
      
      for(let i=0;i<topMid.length;i++){
        const s=topMid[i],code=s.mksc_shrn_iscd||s.stck_shrn_iscd;
        setProg(`ì¤‘ê°€ì£¼(${i+1}/${topMid.length}) ${s.hts_kor_isnm}`);
        await new Promise(r=>setTimeout(r,150));
        const ch=await loadChart(code),a=await analyze(code,s.hts_kor_isnm,ch);
        if(!a.error)results.mid.push({code,name:s.hts_kor_isnm,price:+s.stck_prpr||0,chg:+s.prdy_ctrt||0,volume:+s.acml_vol||0,h52:+s.w52_hgpr||0,l52:+s.w52_lwpr||0,type:'ì¤‘ê°€ì£¼',...a});
      }
      
      // ì •ë ¬
      const sortFn=(list)=>{
        if(mode==='day')return list.sort((a,b)=>(b.chg*2+b.volume/1e6)-(a.chg*2+a.volume/1e6));
        if(mode==='swing')return list.sort((a,b)=>(b.ai?.score||0)-(a.ai?.score||0));
        if(mode==='bottom')return list.filter(x=>x.postSurge?.score>=30).sort((a,b)=>(b.postSurge?.score||0)-(a.postSurge?.score||0));
        if(mode==='bb')return list.filter(x=>x.bbStrat?.sig==='ë§¤ìˆ˜'||x.bbStrat?.sig==='ëŒíŒŒëŒ€ê¸°').sort((a,b)=>(b.ai?.score||0)-(a.ai?.score||0));
        return list;
      };
      
      const sortedLow=sortFn([...results.low]).slice(0,10);
      const sortedMid=sortFn([...results.mid]).slice(0,10);
      
      if(price==='low')setList(sortedLow);
      else if(price==='mid')setList(sortedMid);
      else setList([...sortedLow,...sortedMid]);
      
      setUpd(new Date().toLocaleString('ko-KR'));
    }catch(e){setErr(e.message)}
    setLoad(false);setProg('');
  };

  const refreshFav=async()=>{
    if(!favs.length)return;setLoad(true);setProg('ê´€ì‹¬ì¢…ëª©...');
    const result=[];
    for(let i=0;i<favs.length;i++){
      const f=favs[i];setProg(`${i+1}/${favs.length} ${f.name}`);
      await new Promise(r=>setTimeout(r,150));
      try{
        const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:f.code})}).then(r=>r.json());
        const ch=await loadChart(f.code),a=await analyze(f.code,f.name,ch);
        result.push({...f,price:+pr.data?.stck_prpr||0,chg:+pr.data?.prdy_ctrt||0,volume:+pr.data?.acml_vol||0,h52:+pr.data?.w52_hgpr||0,l52:+pr.data?.w52_lwpr||0,...a});
      }catch{result.push({...f,error:true})}
    }
    setList(result);setUpd(new Date().toLocaleString('ko-KR'));setLoad(false);setProg('');
  };

  const refreshPort=async()=>{
    if(!port.length)return;setLoad(true);setProg('í¬íŠ¸í´ë¦¬ì˜¤...');
    const result=[];
    for(let i=0;i<port.length;i++){
      const p=port[i];setProg(`${i+1}/${port.length} ${p.name}`);
      await new Promise(r=>setTimeout(r,150));
      try{
        const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:p.code})}).then(r=>r.json());
        const cur=+pr.data?.stck_prpr||0,pnl=((cur-p.buy)/p.buy*100).toFixed(2);
        result.push({...p,cur,chg:+pr.data?.prdy_ctrt||0,pnl:+pnl,amt:(cur-p.buy)*p.qty,total:cur*p.qty});
      }catch{result.push({...p,error:true})}
    }
    setList(result);setUpd(new Date().toLocaleString('ko-KR'));setLoad(false);setProg('');
  };

  const searchStock=async()=>{
    if(!search.trim())return;setLoad(true);setErr('');
    try{
      const pr=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:search})}).then(r=>r.json());
      if(pr.success&&pr.data){
        const ch=await loadChart(search),a=await analyze(search,pr.data.hts_kor_isnm||search,ch);
        setList([{code:search,name:pr.data.hts_kor_isnm||search,price:+pr.data.stck_prpr||0,chg:+pr.data.prdy_ctrt||0,volume:+pr.data.acml_vol||0,h52:+pr.data.w52_hgpr||0,l52:+pr.data.w52_lwpr||0,...a}]);
      }else setErr('ì¢…ëª©ì—†ìŒ');
    }catch(e){setErr(e.message)}
    setLoad(false);
  };

  const isFav=c=>favs.some(f=>f.code===c);
  const togFav=(s,e)=>{e?.stopPropagation();setFavs(isFav(s.code)?favs.filter(f=>f.code!==s.code):[...favs,{code:s.code,name:s.name}])};
  const addPort=s=>{setForm({code:s.code,name:s.name,buy:s.price||s.cur,qty:''});setModal('port')};
  const savePort=()=>{if(!form.buy||!form.qty)return;const ex=port.findIndex(p=>p.code===form.code);if(ex>=0){const o=port[ex],tq=o.qty+ +form.qty,avg=Math.round((o.buy*o.qty+ +form.buy*+form.qty)/tq);setPort(port.map((p,i)=>i===ex?{...o,buy:avg,qty:tq}:p))}else setPort([...port,{code:form.code,name:form.name,buy:+form.buy,qty:+form.qty}]);setModal(null)};
  const delPort=c=>setPort(port.filter(p=>p.code!==c));
  const addAlert=s=>{setForm({code:s.code,name:s.name,type:'target',val:''});setModal('alert')};
  const saveAlert=()=>{if(!form.val)return;setAlerts([...alerts,{...form,val:+form.val,on:true}]);setModal(null)};
  const delAlert=i=>setAlerts(alerts.filter((_,j)=>j!==i));
  const togAlert=i=>{const a=[...alerts];a[i].on=!a[i].on;setAlerts(a)};
  const saveMemo=(code,text)=>setMemos({...memos,[code]:text});
  const addTrade=(type,s)=>setTrades([...trades,{...s,type,date:new Date().toISOString()}]);
  const toggleCompare=s=>{if(compare.find(c=>c.code===s.code))setCompare(compare.filter(c=>c.code!==s.code));else if(compare.length<3)setCompare([...compare,s])};

  // ì•Œë¦¼ ì²´í¬
  useEffect(()=>{
    if(!alertOn||!logged)return;
    const chk=async()=>{
      for(const a of alerts){
        if(!a.on)continue;
        try{
          const r=await fetch(API+'/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({appKey:key,appSecret:sec,stockCode:a.code})}).then(r=>r.json());
          const cur=+r.data?.stck_prpr||0,chg=+r.data?.prdy_ctrt||0;
          let fire=false,msg='';
          if(a.type==='target'&&cur>=a.val){fire=true;msg=`${a.name} ëª©í‘œê°€ ë„ë‹¬!`}
          else if(a.type==='stop'&&cur<=a.val){fire=true;msg=`${a.name} ì†ì ˆê°€!`}
          else if(a.type==='surge'&&chg>=a.val){fire=true;msg=`${a.name} +${chg}% ê¸‰ë“±!`}
          else if(a.type==='plunge'&&chg<=-a.val){fire=true;msg=`${a.name} ${chg}% ê¸‰ë½!`}
          else if(a.type==='ma5'&&cur>=a.val){fire=true;msg=`${a.name} 5ì¼ì„  ëŒíŒŒ!`}
          else if(a.type==='rsi30'&&calcRSI([cur])<30){fire=true;msg=`${a.name} RSI 30 ì´í•˜!`}
          if(fire&&Notification.permission==='granted')new Notification('ğŸ“ˆì•Œë¦¼',{body:msg});
        }catch{}
      }
    };
    const iv=setInterval(chk,60000);return()=>clearInterval(iv);
  },[alerts,alertOn,logged]);

  // ìˆ˜ìµë¥  í†µê³„
  const getStats=()=>{
    const wins=trades.filter(t=>t.type==='sell'&&t.pnl>0).length;
    const total=trades.filter(t=>t.type==='sell').length;
    const winRate=total?((wins/total)*100).toFixed(1):0;
    const totalPnl=trades.filter(t=>t.type==='sell').reduce((s,t)=>s+(t.amt||0),0);
    return{wins,total,winRate,totalPnl};
  };

  const SigBadge=({s})=>{
    const c={'ê°•ë ¥ë§¤ìˆ˜':'bg-green-600','ë§¤ìˆ˜':'bg-green-500','ê´€ë§':'bg-yellow-500 text-black','ë§¤ë„':'bg-red-500','ê°•ë ¥ë§¤ë„':'bg-red-600'};
    return<span className={`px-1.5 py-0.5 rounded text-[10px] font-bold ${c[s]||'bg-gray-500'}`}>{s}</span>;
  };

  const AIPanel=({s})=>{
    const ai=s.ai;if(!ai)return null;
    return(
      <div className="bg-gradient-to-br from-purple-900/40 to-blue-900/40 rounded p-2 mt-2 border border-purple-500/30">
        <div className="flex justify-between items-center mb-1">
          <span className="text-xs font-bold">ğŸ¤– AI</span>
          <span className={`font-bold ${ai.score>0?'text-green-400':'text-red-400'}`}>{ai.score>0?'+':''}{ai.score}</span>
        </div>
        <div className="text-center mb-2">
          <div className="text-lg font-bold">{ai.action}</div>
          <div className="text-[10px] text-gray-400">ì‹ ë¢°ë„ {ai.confidence}%</div>
          <div className="w-full bg-gray-700 rounded-full h-1 mt-1"><div className={`h-1 rounded-full ${ai.score>0?'bg-green-500':'bg-red-500'}`} style={{width:`${ai.confidence}%`}}/></div>
        </div>
        <div className="grid grid-cols-3 gap-1 text-[10px] mb-1">
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ë¦¬ìŠ¤í¬</span><div className={ai.risk==='ë†’ìŒ'?'text-red-400':ai.risk==='ë‚®ìŒ'?'text-green-400':'text-yellow-400'}>{ai.risk}</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ëª©í‘œ</span><div className="text-green-400">{fmtNum(ai.target)}</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ì†ì ˆ</span><div className="text-red-400">{fmtNum(ai.stopLoss)}</div></div>
        </div>
        <div className="text-[9px] text-gray-400">{ai.reasons?.join(' â€¢ ')}</div>
      </div>
    );
  };

  const BBPanel=({bb,bbStrat})=>{
    if(!bb)return null;
    return(
      <div className="bg-gradient-to-r from-cyan-900/40 to-teal-900/40 rounded p-2 mt-1 border border-cyan-500/30">
        <div className="flex justify-between items-center mb-1">
          <span className="text-xs font-bold">ğŸ“Š ë³¼ë¦°ì €ë°´ë“œ</span>
          <span className={`text-xs font-bold ${bbStrat?.sig==='ë§¤ìˆ˜'?'text-green-400':bbStrat?.sig?.includes('ë§¤ë„')?'text-red-400':'text-gray-400'}`}>{bbStrat?.sig}</span>
        </div>
        <div className="grid grid-cols-4 gap-1 text-[9px]">
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">%B</span><div className={bb.pctB<20?'text-blue-400':bb.pctB>80?'text-red-400':'text-gray-300'}>{bb.pctB}%</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ë°´ë“œí­</span><div>{bb.width}%</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ìƒë‹¨</span><div className="text-red-300">{fmtNum(Math.round(bb.u))}</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">í•˜ë‹¨</span><div className="text-blue-300">{fmtNum(Math.round(bb.l))}</div></div>
        </div>
        <div className="text-[9px] text-cyan-300 mt-1">ğŸ’¡ {bbStrat?.desc}</div>
      </div>
    );
  };

  const PostSurgePanel=({ps})=>{
    if(!ps?.isPostSurge)return null;
    return(
      <div className="bg-gradient-to-r from-orange-900/40 to-red-900/40 rounded p-2 mt-1 border border-orange-500/30">
        <div className="flex justify-between items-center mb-1">
          <span className="text-xs font-bold">ğŸ”¥ ê¸‰ë“±í›„ì €ì </span>
          <span className="text-orange-400 font-bold">{ps.score}ì </span>
        </div>
        <div className="grid grid-cols-3 gap-1 text-[9px]">
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">6ê°œì›”â†“</span><div className="text-red-400">-{ps.drop6m}%</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ë°˜ë“±ëª©í‘œ</span><div className="text-green-400">{fmtNum(ps.recovery)}</div></div>
          <div className="bg-gray-800/50 rounded p-1 text-center"><span className="text-gray-400">ì €ì ëŒ€ë¹„</span><div className="text-blue-400">+{ps.fromLow}%</div></div>
        </div>
      </div>
    );
  };

  const Card=({s,i,rank=true,isPort=false})=>(
    <div onClick={()=>{setSel(sel?.code===s.code?null:s);sel?.code!==s.code&&loadChart(s.code)}} className="bg-gray-800 rounded-lg p-2 border border-gray-700 mb-2">
      <div className="flex justify-between items-start mb-1">
        <div className="flex items-center gap-1">
          {rank&&<span className="text-sm font-bold text-yellow-500">#{i+1}</span>}
          <div>
            <div className="font-bold text-xs flex items-center gap-1">{s.name}{s.postSurge?.isPostSurge&&<span className="text-orange-400 text-[9px]">ğŸ”¥</span>}{s.type&&<span className="text-[8px] text-gray-500">{s.type}</span>}</div>
            <div className="text-gray-400 text-[10px]">{s.code}</div>
          </div>
        </div>
        <div className="flex items-center gap-1">
          <button onClick={e=>{e.stopPropagation();toggleCompare(s)}} className={`text-sm ${compare.find(c=>c.code===s.code)?'text-cyan-400':'text-gray-500'}`}>âš–ï¸</button>
          <button onClick={e=>togFav(s,e)} className={`text-sm ${isFav(s.code)?'text-yellow-400':'text-gray-500'}`}>{isFav(s.code)?'â˜…':'â˜†'}</button>
          <button onClick={e=>{e.stopPropagation();addAlert(s)}} className="text-sm text-gray-500">ğŸ””</button>
          <button onClick={e=>{e.stopPropagation();addPort(s)}} className="text-sm text-gray-500">ğŸ’¼</button>
          {s.sig&&<SigBadge s={s.sig}/>}
        </div>
      </div>
      
      {isPort&&s.cur?(
        <div className="bg-gray-700/50 rounded p-2 mb-1 text-[10px]">
          <div className="grid grid-cols-2 gap-1"><div>ë§¤ìˆ˜: {fmtNum(s.buy)}ì›</div><div>í˜„ì¬: {fmtNum(s.cur)}ì›</div><div>ìˆ˜ëŸ‰: {s.qty}ì£¼</div><div>í‰ê°€: {fmtNum(s.total)}ì›</div></div>
          <div className={`text-center font-bold mt-1 ${s.pnl>=0?'text-red-400':'text-blue-400'}`}>{s.pnl>=0?'+':''}{s.pnl}% ({s.amt>=0?'+':''}{fmtNum(s.amt)}ì›)</div>
        </div>
      ):s.price>0&&(
        <>
          <div className="grid grid-cols-2 gap-1 mb-1 text-[10px]">
            <div className="bg-gray-700/50 rounded p-1.5"><span className="text-gray-400">í˜„ì¬ê°€</span><div className="font-bold">{fmtNum(s.price)}ì›</div></div>
            <div className="bg-gray-700/50 rounded p-1.5"><span className="text-gray-400">ë“±ë½</span><div className={`font-bold ${s.chg>=0?'text-red-400':'text-blue-400'}`}>{s.chg>=0?'+':''}{s.chg?.toFixed(2)}%</div></div>
          </div>
          <div className="grid grid-cols-5 gap-0.5 mb-1 text-[9px]">
            <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">RSI</span><div className={s.rsi>70?'text-red-400':s.rsi<30?'text-blue-400':'text-green-400'}>{s.rsi}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ì´í‰</span><div className={s.ma?.status==='ì •ë°°ì—´'?'text-green-400':s.ma?.status==='ì—­ë°°ì—´'?'text-red-400':'text-purple-400'}>{s.ma?.status?.slice(0,2)}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">MACD</span><div className={s.macd?.cross==='golden'?'text-green-400':'text-red-400'}>{s.macd?.cross==='golden'?'ê³¨ë“ ':'ë°ë“œ'}</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">BB</span><div className={s.bb?.pos==='low'?'text-blue-400':s.bb?.pos==='high'?'text-red-400':'text-gray-400'}>{s.bb?.pctB}%</div></div>
            <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ê±°ë˜</span><div className={s.vol?.s==='í­ì¦'?'text-red-400':s.vol?.s==='ê¸‰ì¦'?'text-orange-400':'text-gray-400'}>{s.vol?.s}</div></div>
          </div>
          <div className="flex gap-1 items-center flex-wrap">
            <span className="bg-blue-900/50 text-blue-300 px-1.5 py-0.5 rounded text-[9px]">{s.strat}</span>
            {s.bbStrat?.sig!=='ê´€ë§'&&<span className="bg-cyan-900/50 text-cyan-300 px-1.5 py-0.5 rounded text-[9px]">BB:{s.bbStrat?.sig}</span>}
            <button onClick={e=>{e.stopPropagation();setShowAI(showAI===s.code?null:s.code)}} className="text-purple-400 text-[10px] ml-auto">ğŸ¤–{showAI===s.code?'â–²':'â–¼'}</button>
          </div>
          {showAI===s.code&&<><AIPanel s={s}/><BBPanel bb={s.bb} bbStrat={s.bbStrat}/>{s.postSurge?.isPostSurge&&<PostSurgePanel ps={s.postSurge}/>}</>}
        </>
      )}
      
      {sel?.code===s.code&&(
        <div className="mt-2 pt-2 border-t border-gray-700">
          <div className="flex gap-1 mb-1 flex-wrap">
            {['w','m','q','h','y'].map(p=><button key={p} onClick={e=>{e.stopPropagation();setPeriod(p)}} className={`px-1.5 py-0.5 rounded text-[9px] ${period===p?'bg-blue-600':'bg-gray-700'}`}>{p==='w'?'1ì£¼':p==='m'?'1ì›”':p==='q'?'3ì›”':p==='h'?'6ì›”':'1ë…„'}</button>)}
            <button onClick={e=>{e.stopPropagation();setShowBB(!showBB)}} className={`px-1.5 py-0.5 rounded text-[9px] ${showBB?'bg-cyan-600':'bg-gray-700'}`}>BB</button>
          </div>
          {charts[s.code]?<><PriceChart data={charts[s.code]} name={s.name} period={period} showBB={showBB}/><VolChart data={charts[s.code]} period={period}/></>:<div className="h-32 flex items-center justify-center text-gray-400 text-xs">ë¡œë”©...</div>}
          {s.sr&&<div className="grid grid-cols-2 gap-1 text-[9px] mt-1"><div className="bg-red-900/30 rounded p-1"><span className="text-gray-400">ì €í•­</span>{s.sr.resistance?.slice(0,2).map((r,i)=><div key={i} className="text-red-400">{fmtNum(r)}</div>)}</div><div className="bg-blue-900/30 rounded p-1"><span className="text-gray-400">ì§€ì§€</span>{s.sr.support?.slice(0,2).map((r,i)=><div key={i} className="text-blue-400">{fmtNum(r)}</div>)}</div></div>}
          {s.fib&&<div className="bg-gray-700/30 rounded p-1 mt-1 text-[8px]"><span className="text-gray-400">í”¼ë³´ë‚˜ì¹˜: </span><span className="text-purple-400">38.2%:{fmtNum(Math.round(s.fib.l618))}</span> <span className="text-yellow-400">50%:{fmtNum(Math.round(s.fib.l50))}</span> <span className="text-green-400">61.8%:{fmtNum(Math.round(s.fib.l382))}</span></div>}
          <div className="mt-1"><textarea value={memos[s.code]||''} onChange={e=>saveMemo(s.code,e.target.value)} onClick={e=>e.stopPropagation()} className="w-full bg-gray-700 rounded p-1.5 text-[10px] h-12 resize-none" placeholder="ë©”ëª¨..."/></div>
        </div>
      )}
      <div className="text-center text-[9px] text-gray-500 mt-1">{sel?.code===s.code?'â–²':'â–¼'}</div>
    </div>
  );

  const PortSum=()=>{
    if(tab!=='port'||!list.length||!list[0].total)return null;
    const inv=list.reduce((s,i)=>s+(i.buy||0)*(i.qty||0),0),val=list.reduce((s,i)=>s+(i.total||0),0),pnl=val-inv,rate=inv?((pnl/inv)*100).toFixed(2):0;
    return<div className="bg-gradient-to-r from-green-800 to-blue-800 rounded-lg p-2 mb-2"><div className="text-[10px] text-gray-300">í‰ê°€ê¸ˆì•¡</div><div className="text-lg font-bold">{fmtNum(val)}ì›</div><div className={pnl>=0?'text-red-300':'text-blue-300'}>{pnl>=0?'+':''}{fmtNum(pnl)}ì› ({pnl>=0?'+':''}{rate}%)</div></div>;
  };

  const ComparePanel=()=>{
    if(compare.length<2)return null;
    return(
      <div className="bg-gray-800 rounded-lg p-2 mb-2 border border-cyan-500/30">
        <div className="text-xs font-bold mb-2">âš–ï¸ ì¢…ëª©ë¹„êµ</div>
        <div className="overflow-x-auto"><table className="w-full text-[9px]"><thead><tr className="text-gray-400"><th></th>{compare.map(c=><th key={c.code}>{c.name}</th>)}</tr></thead><tbody>
          <tr><td className="text-gray-400">ê°€ê²©</td>{compare.map(c=><td key={c.code}>{fmtNum(c.price)}</td>)}</tr>
          <tr><td className="text-gray-400">ë“±ë½</td>{compare.map(c=><td key={c.code} className={c.chg>=0?'text-red-400':'text-blue-400'}>{c.chg?.toFixed(2)}%</td>)}</tr>
          <tr><td className="text-gray-400">RSI</td>{compare.map(c=><td key={c.code}>{c.rsi}</td>)}</tr>
          <tr><td className="text-gray-400">AIì ìˆ˜</td>{compare.map(c=><td key={c.code} className={c.ai?.score>0?'text-green-400':'text-red-400'}>{c.ai?.score}</td>)}</tr>
          <tr><td className="text-gray-400">ì‹ í˜¸</td>{compare.map(c=><td key={c.code}>{c.sig}</td>)}</tr>
        </tbody></table></div>
        <button onClick={()=>setCompare([])} className="text-[10px] text-gray-400 mt-1">ì´ˆê¸°í™”</button>
      </div>
    );
  };

  const StatsPanel=()=>{
    const stats=getStats();
    return(
      <div className="bg-gray-800 rounded-lg p-2 mb-2">
        <div className="text-xs font-bold mb-1">ğŸ“Š ë§¤ë§¤í†µê³„</div>
        <div className="grid grid-cols-4 gap-1 text-[10px]">
          <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ì´ê±°ë˜</span><div>{stats.total}</div></div>
          <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ìŠ¹</span><div className="text-green-400">{stats.wins}</div></div>
          <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ìŠ¹ë¥ </span><div className={+stats.winRate>50?'text-green-400':'text-red-400'}>{stats.winRate}%</div></div>
          <div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ìˆ˜ìµ</span><div className={stats.totalPnl>=0?'text-green-400':'text-red-400'}>{fmtNum(stats.totalPnl)}</div></div>
        </div>
      </div>
    );
  };

  const CalcModal=()=>{
    const[calcType,setCalcType]=useState('dca');
    const[v,setV]=useState({buy:0,qty:0,add:0,addQty:0,entry:0,target:0,stop:0,capital:1000000,risk:2});
    if(!calcModal)return null;
    return(
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setCalcModal(null)}>
        <div className="bg-gray-800 rounded-xl p-4 w-full max-w-sm" onClick={e=>e.stopPropagation()}>
          <div className="flex gap-2 mb-3">{['dca','rr','pos'].map(t=><button key={t} onClick={()=>setCalcType(t)} className={`flex-1 py-1 rounded text-xs ${calcType===t?'bg-blue-600':'bg-gray-700'}`}>{t==='dca'?'ë¶„í• ë§¤ìˆ˜':t==='rr'?'ì†ìµë¹„':'í¬ì§€ì…˜'}</button>)}</div>
          {calcType==='dca'&&<div className="space-y-2 text-sm">
            <input type="number" placeholder="ê¸°ì¡´ë§¤ìˆ˜ê°€" onChange={e=>setV({...v,buy:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ê¸°ì¡´ìˆ˜ëŸ‰" onChange={e=>setV({...v,qty:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ì¶”ê°€ë§¤ìˆ˜ê°€" onChange={e=>setV({...v,add:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ì¶”ê°€ìˆ˜ëŸ‰" onChange={e=>setV({...v,addQty:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            {v.buy>0&&v.qty>0&&v.add>0&&v.addQty>0&&<div className="bg-blue-900/50 rounded p-2 text-center">í‰ê· ë‹¨ê°€: <b>{fmtNum(calcDCA(v.buy,v.qty,v.add,v.addQty).avgPrice)}</b>ì› / {calcDCA(v.buy,v.qty,v.add,v.addQty).totalQty}ì£¼</div>}
          </div>}
          {calcType==='rr'&&<div className="space-y-2 text-sm">
            <input type="number" placeholder="ì§„ì…ê°€" onChange={e=>setV({...v,entry:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ëª©í‘œê°€" onChange={e=>setV({...v,target:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ì†ì ˆê°€" onChange={e=>setV({...v,stop:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            {v.entry>0&&v.target>0&&v.stop>0&&<div className="bg-blue-900/50 rounded p-2 text-center">ì†ìµë¹„: <b>{calcRiskReward(v.entry,v.target,v.stop)}</b> : 1</div>}
          </div>}
          {calcType==='pos'&&<div className="space-y-2 text-sm">
            <input type="number" placeholder="ì´ìë³¸" value={v.capital} onChange={e=>setV({...v,capital:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ë¦¬ìŠ¤í¬%" value={v.risk} onChange={e=>setV({...v,risk:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ì§„ì…ê°€" onChange={e=>setV({...v,entry:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            <input type="number" placeholder="ì†ì ˆê°€" onChange={e=>setV({...v,stop:+e.target.value})} className="w-full bg-gray-700 rounded p-2"/>
            {v.entry>0&&v.stop>0&&<div className="bg-blue-900/50 rounded p-2 text-center">ë§¤ìˆ˜ìˆ˜ëŸ‰: <b>{calcPositionSize(v.capital,v.risk,v.entry,v.stop)}</b>ì£¼</div>}
          </div>}
          <button onClick={()=>setCalcModal(null)} className="w-full mt-3 py-2 bg-gray-700 rounded">ë‹«ê¸°</button>
        </div>
      </div>
    );
  };

  if(!logged)return(
    <div className={`min-h-screen flex items-center justify-center p-4 ${dark?'bg-gray-900':'bg-gray-100'}`}>
      <div className={`max-w-sm w-full ${dark?'bg-gray-800':'bg-white'} rounded-2xl p-5 shadow-xl`}>
        <h1 className="text-xl font-bold text-center mb-1">ğŸ‡°ğŸ‡· ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ Pro Max</h1>
        <p className="text-gray-400 text-xs text-center mb-4">KIS API + AI + ë³¼ë¦°ì €ë°´ë“œ</p>
        <div className="space-y-3">
          <input value={key} onChange={e=>setKey(e.target.value)} className={`w-full ${dark?'bg-gray-700':'bg-gray-100'} rounded-lg px-3 py-2 text-sm`} placeholder="APP KEY"/>
          <input type="password" value={sec} onChange={e=>setSec(e.target.value)} className={`w-full ${dark?'bg-gray-700':'bg-gray-100'} rounded-lg px-3 py-2 text-sm`} placeholder="APP SECRET"/>
          {err&&<div className="text-red-400 text-xs">{err}</div>}
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={save} onChange={e=>setSave(e.target.checked)}/>ğŸ” ì €ì¥</label>
          <button onClick={login} disabled={load} className="w-full bg-blue-600 py-2.5 rounded-lg font-bold disabled:opacity-50">{load?'...':'ğŸ”— ë¡œê·¸ì¸'}</button>
        </div>
      </div>
    </div>
  );

  return(
    <div className={`min-h-screen pb-16 ${dark?'bg-gray-900 text-white':'bg-gray-100 text-gray-900'}`}>
      <div className="max-w-lg mx-auto p-2">
        <div className="bg-gradient-to-r from-blue-700 to-purple-700 rounded-lg p-2 mb-2">
          <div className="flex justify-between items-center">
            <div><h1 className="font-bold text-white text-sm">ğŸ‡°ğŸ‡· Pro Max</h1><div className="flex items-center gap-1">{upd&&<span className="text-[9px] text-gray-300">{upd}</span>}{autoRefresh&&<span className="text-[9px] text-green-300 animate-pulse-slow">ğŸ”„</span>}</div></div>
            <div className="flex gap-1">
              <button onClick={()=>setCalcModal(true)} className="bg-gray-700 px-2 py-1 rounded text-xs">ğŸ§®</button>
              <button onClick={()=>{if(tab==='scan')scan();else if(tab==='fav')refreshFav();else if(tab==='port')refreshPort();else if(tab==='search')searchStock()}} disabled={load} className="bg-white text-purple-800 px-2 py-1 rounded font-bold text-sm disabled:opacity-50">{load?'â³':'ğŸ”'}</button>
            </div>
          </div>
        </div>
        
        {err&&<div className="bg-red-900/50 rounded p-2 mb-2 text-red-300 text-xs">{err}</div>}
        
        <div className="flex gap-1 mb-2 overflow-x-auto scrollbar-hide text-[10px]">
          {[{id:'scan',i:'ğŸ”',l:'ìŠ¤í¬ë¦¬ë‹'},{id:'fav',i:'â­',l:`ê´€ì‹¬(${favs.length})`},{id:'port',i:'ğŸ’¼',l:'í¬íŠ¸'},{id:'search',i:'ğŸ”',l:'ê²€ìƒ‰'},{id:'rank',i:'ğŸ†',l:'ë­í‚¹'},{id:'alert',i:'ğŸ””',l:'ì•Œë¦¼'},{id:'stat',i:'ğŸ“Š',l:'í†µê³„'},{id:'set',i:'âš™ï¸',l:'ì„¤ì •'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setList([]);setShowAI(null)}} className={`px-2 py-1 rounded font-bold whitespace-nowrap ${tab===t.id?'bg-blue-600':'bg-gray-800'}`}>{t.i}{t.l}</button>)}
        </div>
        
        {tab==='scan'&&<>
          <div className="flex gap-1 mb-1">
            {[['day','ğŸ”¥ë°ì´'],['swing','ğŸ“ŠìŠ¤ìœ™'],['bottom','ğŸ”¥ì €ì '],['bb','ğŸ“ŠBB']].map(([m,l])=><button key={m} onClick={()=>setMode(m)} className={`flex-1 py-1 rounded font-bold text-[10px] ${mode===m?'bg-blue-600':'bg-gray-800'}`}>{l}</button>)}
          </div>
          <div className="flex gap-1 mb-2">
            {[['all','ì „ì²´'],['low','ğŸª™ë™ì „'],['mid','ğŸ’µì¤‘ê°€']].map(([p,l])=><button key={p} onClick={()=>setPrice(p)} className={`flex-1 py-1 rounded font-bold text-[10px] ${price===p?'bg-green-600':'bg-gray-800'}`}>{l}</button>)}
          </div>
          {mode==='bb'&&<div className="bg-cyan-900/30 rounded p-1.5 mb-2 text-[10px] text-cyan-300">ğŸ“Š ë³¼ë¦°ì €ë°´ë“œ í•˜ë‹¨ë°˜ë“± + ìŠ¤í€´ì¦ˆ ì¢…ëª©</div>}
        </>}
        
        {tab==='search'&&<div className="mb-2"><input value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==='Enter'&&searchStock()} className="w-full bg-gray-800 rounded px-3 py-2 text-sm" placeholder="ì¢…ëª©ì½”ë“œ 6ìë¦¬"/></div>}
        
        {tab==='rank'&&list.length>0&&<div className="mb-2"><div className="text-xs font-bold mb-1">ğŸ† AIì ìˆ˜ TOP</div>{[...list].sort((a,b)=>(b.ai?.score||0)-(a.ai?.score||0)).slice(0,5).map((s,i)=><div key={s.code} className="flex justify-between items-center bg-gray-800 rounded p-1.5 mb-1 text-xs"><span>#{i+1} {s.name}</span><span className={s.ai?.score>0?'text-green-400':'text-red-400'}>{s.ai?.score}ì </span></div>)}</div>}
        
        {tab==='alert'&&<div className="space-y-2">
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded"><span className="text-xs">ğŸ”” ì•Œë¦¼</span><button onClick={()=>setAlertOn(!alertOn)} className={`w-10 h-5 rounded-full ${alertOn?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full transform ${alertOn?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {alerts.map((a,i)=><div key={i} className="p-2 bg-gray-800 rounded flex justify-between text-xs"><div><b>{a.name}</b><div className="text-gray-400">{a.type} {fmtNum(a.val)}</div></div><div className="flex gap-2"><button onClick={()=>togAlert(i)} className={`w-8 h-4 rounded-full ${a.on?'bg-green-500':'bg-gray-600'}`}><div className={`w-3 h-3 bg-white rounded-full ${a.on?'translate-x-4':'translate-x-0.5'}`}/></button><button onClick={()=>delAlert(i)} className="text-red-400">ğŸ—‘</button></div></div>)}
        </div>}
        
        {tab==='stat'&&<StatsPanel/>}
        
        {tab==='set'&&<div className="space-y-2">
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded text-xs"><span>{dark?'ğŸŒ™ë‹¤í¬':'â˜€ï¸ë¼ì´íŠ¸'}</span><button onClick={()=>setDark(!dark)} className={`w-10 h-5 rounded-full ${dark?'bg-blue-500':'bg-yellow-500'}`}><div className={`w-4 h-4 bg-white rounded-full ${dark?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded text-xs"><span>ğŸ”„ìë™ìƒˆë¡œê³ ì¹¨</span><button onClick={()=>setAutoRefresh(!autoRefresh)} className={`w-10 h-5 rounded-full ${autoRefresh?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full ${autoRefresh?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {autoRefresh&&<div className="flex gap-1">{[30,60,120].map(s=><button key={s} onClick={()=>setRefreshInterval(s)} className={`flex-1 py-1 rounded text-xs ${refreshInterval===s?'bg-blue-600':'bg-gray-700'}`}>{s}ì´ˆ</button>)}</div>}
          <div className="p-2 bg-gray-800 rounded text-xs"><div>ê´€ì‹¬:{favs.length} í¬íŠ¸:{port.length} ì•Œë¦¼:{alerts.length}</div><button onClick={()=>confirm('ì‚­ì œ?')&&(setFavs([]),setPort([]),setAlerts([]),setMemos({}),setTrades([]),localStorage.clear())} className="mt-2 w-full py-1.5 bg-red-600 rounded">ğŸ—‘ì „ì²´ì‚­ì œ</button></div>
          <button onClick={logout} className="w-full py-2 bg-gray-700 rounded text-xs">ğŸšªë¡œê·¸ì•„ì›ƒ</button>
        </div>}
        
        <ComparePanel/>
        <PortSum/>
        
        {list.length>0&&!load&&!['alert','set','stat'].includes(tab)&&<div>{list.map((s,i)=><Card key={s.code} s={s} i={i} rank={tab==='scan'||tab==='rank'} isPort={tab==='port'}/>)}</div>}
        
        {!list.length&&!load&&!['alert','set','stat'].includes(tab)&&<div className="text-center py-8"><div className="text-3xl mb-2">{tab==='scan'?'ğŸ“ˆ':tab==='fav'?'â­':tab==='port'?'ğŸ’¼':'ğŸ”'}</div><p className="text-gray-400 text-sm">ğŸ” ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘</p></div>}
        
        {load&&<div className="text-center py-8"><div className="text-3xl animate-bounce">ğŸ”</div><p className="text-gray-400 text-xs mt-2">{prog}</p></div>}
      </div>
      
      {modal==='port'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-4 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-2 text-sm">ğŸ’¼ í¬íŠ¸í´ë¦¬ì˜¤</h3><div className="text-xs mb-2">{form.name}</div><input type="number" value={form.buy} onChange={e=>setForm({...form,buy:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ë§¤ìˆ˜ê°€"/><input type="number" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ìˆ˜ëŸ‰"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded text-sm">ì·¨ì†Œ</button><button onClick={savePort} className="flex-1 py-2 bg-blue-600 rounded text-sm font-bold">ì €ì¥</button></div></div></div>}
      
      {modal==='alert'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-4 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-2 text-sm">ğŸ”” ì•Œë¦¼</h3><div className="text-xs mb-2">{form.name}</div><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm"><option value="target">ëª©í‘œê°€</option><option value="stop">ì†ì ˆê°€</option><option value="surge">ê¸‰ë“±%</option><option value="plunge">ê¸‰ë½%</option><option value="ma5">5ì¼ì„ ëŒíŒŒ</option><option value="rsi30">RSI30ì´í•˜</option></select><input type="number" value={form.val} onChange={e=>setForm({...form,val:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ê°’"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded text-sm">ì·¨ì†Œ</button><button onClick={saveAlert} className="flex-1 py-2 bg-blue-600 rounded text-sm font-bold">ì €ì¥</button></div></div></div>}
      
      <CalcModal/>
    </div>
  );
};

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
-gray-300">{upd}</span>}{autoRef&&<span className="text-[8px] text-green-300 anim-pulse">ğŸ”„</span>}</div></div>
            <div className="flex gap-1">
              <button onClick={()=>setCalcMod(true)} className="bg-gray-700 px-2 py-1 rounded text-xs">ğŸ§®</button>
              <button onClick={()=>{if(tab==='scan')scan();else if(tab==='fav')refreshFav();else if(tab==='port')refreshPort();else if(tab==='search')searchStock()}} disabled={load} className="bg-white text-purple-800 px-2 py-1 rounded font-bold text-sm disabled:opacity-50">{load?'â³':'ğŸ”'}</button>
            </div>
          </div>
        </div>
        
        {err&&<div className="bg-red-900/50 rounded p-1.5 mb-2 text-red-300 text-xs">{err}</div>}
        
        <div className="flex gap-1 mb-2 overflow-x-auto scroll-hide text-[9px]">
          {[{id:'scan',i:'ğŸ”',l:'ìŠ¤í¬ë¦°'},{id:'fav',i:'â­',l:`ê´€ì‹¬(${favs.length})`},{id:'port',i:'ğŸ’¼',l:'í¬íŠ¸'},{id:'search',i:'ğŸ”',l:'ê²€ìƒ‰'},{id:'rank',i:'ğŸ†',l:'ë­í‚¹'},{id:'report',i:'ğŸ“‹',l:'ë¦¬í¬íŠ¸'},{id:'alert',i:'ğŸ””',l:'ì•Œë¦¼'},{id:'stat',i:'ğŸ“Š',l:'í†µê³„'},{id:'set',i:'âš™ï¸',l:'ì„¤ì •'}].map(t=><button key={t.id} onClick={()=>{setTab(t.id);setList([]);setShowAI(null)}} className={`px-1.5 py-1 rounded font-bold whitespace-nowrap ${tab===t.id?'bg-blue-600':'bg-gray-800'}`}>{t.i}{t.l}</button>)}
        </div>
        
        {tab==='scan'&&<>
          <div className="flex gap-0.5 mb-1 flex-wrap">
            {[['day','ğŸ”¥ë°ì´'],['swing','ğŸ“ŠìŠ¤ìœ™'],['bottom','ğŸ”¥ì €ì '],['bb','ğŸ“ŠBB'],['pattern','ğŸ“ŠíŒ¨í„´'],['ichi','â˜ï¸ì¼ëª©']].map(([m,l])=><button key={m} onClick={()=>setMode(m)} className={`px-2 py-1 rounded font-bold text-[9px] ${mode===m?'bg-blue-600':'bg-gray-800'}`}>{l}</button>)}
          </div>
          <div className="flex gap-1 mb-2">
            {[['all','ì „ì²´'],['low','ğŸª™ë™ì „'],['mid','ğŸ’µì¤‘ê°€']].map(([p,l])=><button key={p} onClick={()=>setPrice(p)} className={`flex-1 py-1 rounded font-bold text-[9px] ${price===p?'bg-green-600':'bg-gray-800'}`}>{l}</button>)}
          </div>
        </>}
        
        {tab==='search'&&<div className="mb-2"><input value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==='Enter'&&searchStock()} className="w-full bg-gray-800 rounded px-3 py-2 text-sm" placeholder="ì¢…ëª©ì½”ë“œ 6ìë¦¬"/></div>}
        
        {tab==='rank'&&list.length>0&&<div className="mb-2 text-[10px]"><div className="font-bold mb-1">ğŸ† AI TOP5</div>{[...list].sort((a,b)=>(b.ai?.sc||0)-(a.ai?.sc||0)).slice(0,5).map((s,i)=><div key={s.code} className="flex justify-between bg-gray-800 rounded p-1 mb-0.5"><span>#{i+1} {s.name}</span><span className={s.ai?.sc>0?'text-green-400':'text-red-400'}>{s.ai?.sc}ì </span></div>)}</div>}
        
        {tab==='report'&&list.length>0&&<ReportPanel/>}
        
        {tab==='alert'&&<div className="space-y-1.5 text-[10px]">
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded"><span>ğŸ””ì•Œë¦¼</span><button onClick={()=>setAlertOn(!alertOn)} className={`w-10 h-5 rounded-full ${alertOn?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full transform ${alertOn?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {alerts.map((a,i)=><div key={i} className="p-1.5 bg-gray-800 rounded flex justify-between"><div><b>{a.name}</b> {a.type} {fmtN(a.val)}</div><div className="flex gap-1"><button onClick={()=>togAlert(i)} className={`w-8 h-4 rounded-full ${a.on?'bg-green-500':'bg-gray-600'}`}><div className={`w-3 h-3 bg-white rounded-full ${a.on?'translate-x-4':'translate-x-0.5'}`}/></button><button onClick={()=>delAlert(i)} className="text-red-400">ğŸ—‘</button></div></div>)}
        </div>}
        
        {tab==='stat'&&<div className="bg-gray-800 rounded-lg p-2 mb-2 text-[10px]">
          <div className="font-bold mb-1">ğŸ“Š ë§¤ë§¤í†µê³„</div>
          {(()=>{const st=getStats();return<div className="grid grid-cols-4 gap-1"><div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ê±°ë˜</span><div>{st.total}</div></div><div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ìŠ¹</span><div className="text-green-400">{st.wins}</div></div><div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ìŠ¹ë¥ </span><div className={+st.rate>50?'text-green-400':'text-red-400'}>{st.rate}%</div></div><div className="bg-gray-700/50 rounded p-1 text-center"><span className="text-gray-400">ìˆ˜ìµ</span><div className={st.pnl>=0?'text-green-400':'text-red-400'}>{fmtN(st.pnl)}</div></div></div>})()}
        </div>}
        
        {tab==='set'&&<div className="space-y-1.5 text-[10px]">
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded"><span>{dark?'ğŸŒ™ë‹¤í¬':'â˜€ï¸ë¼ì´íŠ¸'}</span><button onClick={()=>setDark(!dark)} className={`w-10 h-5 rounded-full ${dark?'bg-blue-500':'bg-yellow-500'}`}><div className={`w-4 h-4 bg-white rounded-full ${dark?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          <div className="flex justify-between items-center p-2 bg-gray-800 rounded"><span>ğŸ”„ìë™ìƒˆë¡œê³ ì¹¨</span><button onClick={()=>setAutoRef(!autoRef)} className={`w-10 h-5 rounded-full ${autoRef?'bg-green-500':'bg-gray-600'}`}><div className={`w-4 h-4 bg-white rounded-full ${autoRef?'translate-x-5':'translate-x-0.5'}`}/></button></div>
          {autoRef&&<div className="flex gap-1">{[30,60,120].map(s=><button key={s} onClick={()=>setRefInt(s)} className={`flex-1 py-1 rounded ${refInt===s?'bg-blue-600':'bg-gray-700'}`}>{s}ì´ˆ</button>)}</div>}
          <div className="p-2 bg-gray-800 rounded">
            <div className="mb-1">ë°ì´í„°: ê´€ì‹¬{favs.length} í¬íŠ¸{port.length} ì•Œë¦¼{alerts.length}</div>
            <div className="flex gap-1">
              <button onClick={()=>exportCSV(favs,'favs.csv')} className="flex-1 py-1 bg-blue-700 rounded">ğŸ“¤ê´€ì‹¬CSV</button>
              <button onClick={()=>exportCSV(port,'port.csv')} className="flex-1 py-1 bg-blue-700 rounded">ğŸ“¤í¬íŠ¸CSV</button>
            </div>
            <div className="flex gap-1 mt-1">
              <button onClick={backup} className="flex-1 py-1 bg-green-700 rounded">ğŸ’¾ë°±ì—…</button>
              <label className="flex-1 py-1 bg-green-700 rounded text-center cursor-pointer">ğŸ“‚ë³µì›<input type="file" accept=".json" onChange={restore} className="hidden"/></label>
            </div>
            <button onClick={()=>confirm('ì‚­ì œ?')&&(setFavs([]),setPort([]),setAlerts([]),setMemos({}),setTrades([]),localStorage.clear())} className="w-full mt-1 py-1 bg-red-600 rounded">ğŸ—‘ì „ì²´ì‚­ì œ</button>
          </div>
          <button onClick={logout} className="w-full py-2 bg-gray-700 rounded">ğŸšªë¡œê·¸ì•„ì›ƒ</button>
        </div>}
        
        <ComparePanel/>
        <PortSum/>
        
        {list.length>0&&!load&&!['alert','set','stat','report'].includes(tab)&&<div>{list.map((s,i)=><Card key={s.code} s={s} i={i} rank={tab==='scan'||tab==='rank'} isPort={tab==='port'}/>)}</div>}
        
        {!list.length&&!load&&!['alert','set','stat','report'].includes(tab)&&<div className="text-center py-8"><div className="text-2xl mb-2">{tab==='scan'?'ğŸ“ˆ':'ğŸ”'}</div><p className="text-gray-400 text-sm">ğŸ”ì‹œì‘</p></div>}
        
        {load&&<div className="text-center py-8"><div className="text-2xl animate-bounce">ğŸ”</div><p className="text-gray-400 text-xs mt-2">{prog}</p></div>}
      </div>
      
      {modal==='port'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-3 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-2 text-sm">ğŸ’¼í¬íŠ¸</h3><div className="text-xs mb-2">{form.name}</div><input type="number" value={form.buy} onChange={e=>setForm({...form,buy:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ë§¤ìˆ˜ê°€"/><input type="number" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ìˆ˜ëŸ‰"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded">ì·¨ì†Œ</button><button onClick={savePort} className="flex-1 py-2 bg-blue-600 rounded font-bold">ì €ì¥</button></div></div></div>}
      
      {modal==='alert'&&<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}><div className="bg-gray-800 rounded-xl p-3 w-full max-w-xs" onClick={e=>e.stopPropagation()}><h3 className="font-bold mb-2 text-sm">ğŸ””ì•Œë¦¼</h3><div className="text-xs mb-2">{form.name}</div><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm"><option value="target">ëª©í‘œê°€</option><option value="stop">ì†ì ˆê°€</option><option value="surge">ê¸‰ë“±%</option><option value="golden">ê³¨ë“ í¬ë¡œìŠ¤</option><option value="rsi30">RSI&lt;30</option></select><input type="number" value={form.val} onChange={e=>setForm({...form,val:e.target.value})} className="w-full bg-gray-700 rounded p-2 mb-2 text-sm" placeholder="ê°’"/><div className="flex gap-2"><button onClick={()=>setModal(null)} className="flex-1 py-2 bg-gray-700 rounded">ì·¨ì†Œ</button><button onClick={saveAlert} className="flex-1 py-2 bg-blue-600 rounded font-bold">ì €ì¥</button></div></div></div>}
      
      <CalcModal/>
    </div>
  );
};

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
